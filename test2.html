<!DOCTYPE html>
<html>
   <head>
      <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
      <script type="text/javascript" src="js/three.min.js"></script>
      <script type="text/javascript" src="js/stats.min.js"></script>
      <script type="text/javascript" src="js/smasher.js.php"></script>
      <script type="text/javascript" src="js/shaders/BeamShader.js"></script>
      <script type="text/javascript" src="js/shaders/CollisionShader.js"></script>
      <script type="text/javascript" src="js/cvmwebapi-1.1.js"></script>
      <script type="text/javascript" src="theme/bootstrap/bootstrap.min.js"></script>
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/darkstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap-responsive.min.css" />
      <link href='http://fonts.googleapis.com/css?family=Armata' rel='stylesheet' type='text/css'>

      <script type="text/javascript">
      
      var Easing = {
         easeInQuad: function (x, t, b, c, d) {
            return c*(t/=d)*t + b;
         },
         easeOutQuad: function (x, t, b, c, d) {
            return -c *(t/=d)*(t-2) + b;
         },
         easeInOutQuad: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t + b;
            return -c/2 * ((--t)*(t-2) - 1) + b;
         },
         easeInCubic: function (x, t, b, c, d) {
            return c*(t/=d)*t*t + b;
         },
         easeOutCubic: function (x, t, b, c, d) {
            return c*((t=t/d-1)*t*t + 1) + b;
         },
         easeInOutCubic: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t + b;
            return c/2*((t-=2)*t*t + 2) + b;
         },
         easeInQuart: function (x, t, b, c, d) {
            return c*(t/=d)*t*t*t + b;
         },
         easeOutQuart: function (x, t, b, c, d) {
            return -c * ((t=t/d-1)*t*t*t - 1) + b;
         },
         easeInOutQuart: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
            return -c/2 * ((t-=2)*t*t*t - 2) + b;
         },
         easeInQuint: function (x, t, b, c, d) {
            return c*(t/=d)*t*t*t*t + b;
         },
         easeOutQuint: function (x, t, b, c, d) {
            return c*((t=t/d-1)*t*t*t*t + 1) + b;
         },
         easeInOutQuint: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
            return c/2*((t-=2)*t*t*t*t + 2) + b;
         },
         easeInSine: function (x, t, b, c, d) {
            return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
         },
         easeOutSine: function (x, t, b, c, d) {
            return c * Math.sin(t/d * (Math.PI/2)) + b;
         },
         easeInOutSine: function (x, t, b, c, d) {
            return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
         },
         easeInExpo: function (x, t, b, c, d) {
            return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
         },
         easeOutExpo: function (x, t, b, c, d) {
            return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
         },
         easeInOutExpo: function (x, t, b, c, d) {
            if (t==0) return b;
            if (t==d) return b+c;
            if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
            return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
         },
         easeInCirc: function (x, t, b, c, d) {
            return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
         },
         easeOutCirc: function (x, t, b, c, d) {
            return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
         },
         easeInOutCirc: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
            return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
         },
         easeInElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
         },
         easeOutElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
         },
         easeInOutElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
            return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
         },
         easeInBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158;
            return c*(t/=d)*t*((s+1)*t - s) + b;
         },
         easeOutBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158;
            return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
         },
         easeInOutBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158; 
            if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
            return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
         },
         easeInBounce: function (x, t, b, c, d) {
            return c - Easing.easeOutBounce (x, d-t, 0, c, d) + b;
         },
         easeOutBounce: function (x, t, b, c, d) {
            if ((t/=d) < (1/2.75)) {
               return c*(7.5625*t*t) + b;
            } else if (t < (2/2.75)) {
               return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
            } else if (t < (2.5/2.75)) {
               return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
            } else {
               return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
            }
         },
         easeInOutBounce: function (x, t, b, c, d) {
            if (t < d/2) return Easing.easeInBounce (x, t*2, 0, c, d) * .5 + b;
            return Easing.easeOutBounce (x, t*2-d, 0, c, d) * .5 + c*.5 + b;
         }
      };

      var AcceleratorRing = function( camera ) {
         THREE.Object3D.call( this );

         // Prepare variables
         this.cTime = 0;
         this.animations = [];
         this.fxTimer = 0;
         this.fxEasing = Easing.easeOutQuad;
         this.fxDelay = 1000;
         this.fxCompleteCb = null;

         // Animation variables
         this.ringRotationSpeed = 0;
         this.collisionOpacity = 0;

         // ============================
         //       Setup Camera
         // ============================

         // We also control the camera because we provide
         // the animation functions to zoom in and out from 
         // the accelerator ring
         this.camera = camera;
         this.camera.rotation.z = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 50;
         this.camera.rotation.y = Math.PI/2 - 0.5;

         this.camera.position.x = -5;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;


         // ============================
         //       Setup Lighting
         // ============================

         var l = new THREE.PointLight( 0xffffff );
         l.position.set(0, 0, 0);
         this.add(l);

         var l2 = this.lightM = new THREE.PointLight( 0x008080, 0, 20 );
         l2.position.set(0, -15, 0);
         this.add(l2);

         var l3 = this.lightR = new THREE.PointLight( 0x37FFFF, 0, 20 ); //20 );
         l3.position.set(-13, 7.5, 0);
         this.add(l3);

         var l4 = this.lightL = new THREE.PointLight( 0xffaa00, 0, 20 );
         l4.position.set(-13, -7.5, 0);
         this.add(l4);

         // ============================
         //    Setup the two beams
         // ============================

         var beamTex1 = THREE.ImageUtils.loadTexture( 'theme/img/beam-1b.png' );
         beamTex1.wrapS = THREE.RepeatWrapping;
         beamTex1.wrapT = THREE.RepeatWrapping;

         var beamTex2 = THREE.ImageUtils.loadTexture( 'theme/img/beam-2b.png' );
         beamTex2.wrapS = THREE.RepeatWrapping;
         beamTex2.wrapT = THREE.RepeatWrapping;

         var beamShader = BeamShader;
         var beamShaderUniforms2f = this.beamShaderUniformsLf = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms1f = this.beamShaderUniformsRf = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms2b = this.beamShaderUniformsLb = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms1b = this.beamShaderUniformsRb = THREE.UniformsUtils.clone( beamShader.uniforms );
         
         beamShaderUniforms2f['tTexture1'].value = beamTex1;
         beamShaderUniforms2f['tTexture2'].value = beamTex2;
         beamShaderUniforms1f['tTexture1'].value = beamTex1;
         beamShaderUniforms1f['tTexture2'].value = beamTex2;
         beamShaderUniforms2b['tTexture1'].value = beamTex1;
         beamShaderUniforms2b['tTexture2'].value = beamTex2;
         beamShaderUniforms1b['tTexture1'].value = beamTex1;
         beamShaderUniforms1b['tTexture2'].value = beamTex2;
         
         beamShaderUniforms2f['uColor'].value = new THREE.Color( 0xffaa00 );
         beamShaderUniforms1f['uColor'].value = new THREE.Color( 0x37FFFF ); //0x6666FF
         beamShaderUniforms2b['uColor'].value = new THREE.Color( 0xffaa00 );
         beamShaderUniforms1b['uColor'].value = new THREE.Color( 0x37FFFF ); //0x6666FF
         
         var beamMaterial2f = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms2f,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.FrontSide
         } );

         var beamMaterial2b = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms2b,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.BackSide
         } );
         

         var beamMaterial1f = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms1f,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.FrontSide
         } );

         var beamMaterial1b = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms1b,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.BackSide
         } );

         var beamGeom = new THREE.TorusGeometry( 20, 1.2, 20, 20, Math.PI );


         var beamMesh1b = this.beamMeshLb = new THREE.Mesh( beamGeom, beamMaterial1b );
         beamMesh1b.rotation.z = 0;
         beamMesh1b.rotation.y = Math.PI;
         this.add( beamMesh1b );

         var beamMesh1f = this.beamMeshLf = new THREE.Mesh( beamGeom, beamMaterial1f );
         beamMesh1f.rotation.z = 0;
         beamMesh1f.rotation.y = Math.PI;
         this.add( beamMesh1f );

         var beamMesh2b = this.beamMeshRb = new THREE.Mesh( beamGeom, beamMaterial2b );
         beamMesh2b.rotation.z = -Math.PI;
         this.add( beamMesh2b );

         var beamMesh2f = this.beamMeshRf = new THREE.Mesh( beamGeom, beamMaterial2f );
         beamMesh2f.rotation.z = -Math.PI;
         this.add( beamMesh2f );

         // ============================
         //  Setup the ring wireframes
         // ============================

         var backgroundMat = this.backgroundMat = new THREE.MeshPhongMaterial({ side: THREE.FrontSide, transparent: true, color: 0x999999, opacity: 0.4 });
         var wireframeMat  = this.wireframeMat = new THREE.MeshPhongMaterial({ wireframe: true, side: THREE.BackSide, color: 0xffffff });

         var ringBackgroundGeom = new THREE.TorusGeometry( 20, 3, 10, 20, Math.PI );
         var ringBackgroundMesh = this.ringBackgroundMesh = new THREE.Mesh( ringBackgroundGeom, backgroundMat );
         ringBackgroundMesh.rotation.z = Math.PI/2;
         this.add( ringBackgroundMesh );

         var ringOutlineGeom = new THREE.TorusGeometry( 20, 3.1, 18, 25, Math.PI *2 );
         var ringOutlineMesh = this.ringOutlineMesh = new THREE.Mesh( ringOutlineGeom, wireframeMat );
         this.add( ringOutlineMesh );

         // ===============================
         //  Setup the collision animation
         // ===============================

         var clsnFlareTex1 = THREE.ImageUtils.loadTexture( "theme/img/collision-1.png" );
         var clsnFlareTex2 = THREE.ImageUtils.loadTexture( "theme/img/collision-2.png" );

         var flareColor = 0xD1FCEE ; //0xFFBD9D;
         var collisionMaterial1 = this.collisionMaterial1 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial2 = this.collisionMaterial2 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial3 = this.collisionMaterial3 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );

         var collisionSprite1 = this.collisionSprite1 = new THREE.Sprite( collisionMaterial1 );
         collisionSprite1.position.set( -15, 0, 0 );
         collisionSprite1.scale.set( 100, 100, 100 );
         this.add( collisionSprite1 );

         var collisionSprite2 = this.collisionSprite2 = new THREE.Sprite( collisionMaterial2 );
         collisionSprite2.position = collisionSprite1.position.clone();
         collisionSprite2.scale = collisionSprite1.scale.clone();
         this.add( collisionSprite2 );

         var collisionSprite3 = this.collisionSprite3 = new THREE.Sprite( collisionMaterial3 );
         collisionSprite3.position = collisionSprite1.position.clone();
         collisionSprite3.scale = collisionSprite1.scale.clone();
         this.add( collisionSprite3 );

         // ===============================
         //   Prepare useful functions
         // ===============================

         // Target values for various animation parameters
         this.animationTargets = [
            {
               'o': this.camera.position,             // Object
               't': this.camera.position.clone(),     // Target 
               's': this.camera.position.clone(),     // Source
               'v'  : ['x','y','z']                   // Values
            },
            {
               'o': this.camera.rotation,
               't': this.camera.rotation.clone(),
               's': this.camera.rotation.clone(),
               'v'  : ['x','y','z']
            },
            {
               'o': this,
               't': { 'ringRotationSpeed': 0, 'collisionOpacity': 0 },
               's': { 'ringRotationSpeed': 0, 'collisionOpacity': 0 },
               'v'  : [ 'ringRotationSpeed', 'collisionOpacity' ]
            },
            {
               'o': this.lightL,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': this.lightR,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': this.lightM,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': beamShaderUniforms1f['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms1b['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms2f['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms2b['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': this.backgroundMat,
               't': { 'opacity': 0 },
               's': { 'opacity': 0 },
               'v': [ 'opacity' ]
            },
            {
               'o': this.wireframeMat.color,
               't': new THREE.Color(0,0,0),
               's': new THREE.Color(0,0,0),
               'v': [ 'r','g','b' ]
            },
            {
               'o': this.wireframeMat.emissive,
               't': new THREE.Color(0,0,0),
               's': new THREE.Color(0,0,0),
               'v': [ 'r','g','b' ]
            }
         ];

         this.setAnimationTarget = function(index, vars) {
            $.each(vars, (function(k,v) {
               this.animationTargets[index].s[k] = this.animationTargets[index].o[k];
               this.animationTargets[index].t[k] = v;
            }).bind(this));
         }

         /**
          * This function returns an animation cycle: for the collision flare
          * 0.0 - 0.2 => { scale: 0.0 - 0.2, opacity: 0.0 - 1.0 },
          * 0.2 - 0.8 => { scale: 0.2 - 1.0, opacity: 1.0 },
          * 0.8 - 1.0 => { scale: 1.1 - 1.8, opacity: 1.0 - 0.0 }
          */
         this.fxCycle = function(v, maxScale, maxOpacity) {
            if (maxScale == undefined) maxScale = 1.0;
            if (maxOpacity == undefined) maxOpacity = 1.0;
            if (v < 0.2) {
               v = v/0.2;
               return { 
                  's':   (v * 0.2) * maxScale,
                  'o': v * maxOpacity
               };
            } else if (v < 0.8) {
               v = (v-0.2)/0.6;
               return { 
                  's':   (0.2 + v*0.8) * maxScale,
                  'o': 1.0 * maxOpacity
               };
            } else {
               v = (v-0.8)/0.2;
               return { 
                  's':   (1.0 + v*0.2) * maxScale,
                  'o': (1.0 - v) * maxOpacity
               };
            }
         }
      }

      AcceleratorRing.prototype = Object.create( THREE.Object3D.prototype );


      /**
       * Update animation callback
       */
      AcceleratorRing.prototype.onAnimationCompleted = function(cb) {
         this.fxCompleteCb = cb;
      };

      /**
       * Update the beam colors
       */
      AcceleratorRing.prototype.setBeamColors = function( left, right, collision ) {
         this.lightL.color.setHex( left );
         this.beamShaderUniformsLf['uColor'].value.setHex( left );
         this.beamShaderUniformsLb['uColor'].value.setHex( left );

         this.lightR.color.setHex( right );
         this.beamShaderUniformsRf['uColor'].value.setHex( right );
         this.beamShaderUniformsRb['uColor'].value.setHex( right );

         if (collision == undefined) collision = left | right;

         this.collisionMaterial1.color.setHex( collision );
         this.collisionMaterial2.color.setHex( collision );
         this.collisionMaterial3.color.setHex( collision );

      };

      /**
       * Update state/animation of the LHC Ring
       */
      AcceleratorRing.prototype.update = function(delta) {

            // Update current time for the animations
            this.cTime += delta / 3000;

            // Update the beam animation 
            this.beamShaderUniformsLf['uTime'].value += delta/1000;
            this.beamShaderUniformsRf['uTime'].value += delta/1000;
            this.beamShaderUniformsLb['uTime'].value += delta/1000;
            this.beamShaderUniformsRb['uTime'].value += delta/1000;

            // Update the sprite animation
            this.collisionSprite1.rotation += delta / 7000;
            this.collisionSprite2.rotation -= delta / 8000;
            this.collisionSprite3.rotation -= delta / 5000;
            var fx = this.fxCycle( this.cTime % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite1.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial1.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.33333) % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite2.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial2.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.66666) % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite3.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial3.opacity = fx.o;

            // Rotate the wireframe
            if (this.ringRotationSpeed != 0)
               this.ringOutlineMesh.rotation.z += delta * this.ringRotationSpeed / 1000;

            // Update animations
            if (this.fxTimer < this.fxDelay) {

               // Wrap to max
               this.fxTimer += delta;
               if (this.fxTimer > this.fxDelay) this.fxTimer = this.fxDelay;

               // Animation cycle over each object's variables
               for (var i=0; i<this.animationTargets.length; i++) {
                  var o = this.animationTargets[i].o,
                      s = this.animationTargets[i].s,
                      t = this.animationTargets[i].t,
                      v = this.animationTargets[i].v;
                  for (var j=0; j<v.length; j++) {
                     if (typeof(s) == 'number') {
                        o[v[j]] = this.fxEasing(null, this.fxTimer, s, t-s, this.fxDelay);
                     } else {
                        o[v[j]] = this.fxEasing(null, this.fxTimer, s[v[j]], t[v[j]] - s[v[j]], this.fxDelay);
                     }
                  }
               }

               // Check for completion
               if ((this.fxTimer == this.fxDelay) && (this.fxCompleteCb != undefined))
                  this.fxCompleteCb();

            }

      };

      /**
       * Update the current view of the ring
       */
      AcceleratorRing.prototype.setView = function(view) {

         this.fxTimer = 0;

         if (view == 0) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 0 });
            this.setAnimationTarget(1, { 'y': Math.PI/2, 'x': 0   });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 0.5, 'g': 0.5, 'b': 0.5 });
            this.setAnimationTarget(12, { 'r': 0.4, 'g': 0.4, 'b': 0.4 });

         } else if (view == 1) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 40 });
            this.setAnimationTarget(1, { 'y': Math.PI/2 - 0.45, 'x': 0 });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 1,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 0.8, 'g': 0.8, 'b': 0.8 });
            this.setAnimationTarget(12, { 'r': 0.1, 'g': 0.1, 'b': 0.1 });

         } else if (view == 2) {

            this.setAnimationTarget(0, { 'x': -5, 'z': 0 });
            this.setAnimationTarget(1, { 'y': Math.PI/2, 'x': 0 });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 1
            });

            this.setAnimationTarget(3, { 'intensity': 1 });
            this.setAnimationTarget(4, { 'intensity': 1 });
            this.setAnimationTarget(5, { 'intensity': 1 });

            this.setAnimationTarget(6, { 'value': 1 });
            this.setAnimationTarget(7, { 'value': 0.5 });
            this.setAnimationTarget(8, { 'value': 1 });
            this.setAnimationTarget(9, { 'value': 0.5 });

            this.setAnimationTarget(10, { 'opacity': 0.4 });

            this.setAnimationTarget(11, { 'r': 0.2, 'g': 0.2, 'b': 0.2 });
            this.setAnimationTarget(12, { 'r': 0.2, 'g': 0.2, 'b': 0.2 });

         } else if (view == 3) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 20 });
            this.setAnimationTarget(1, { 'y': Math.PI/2 - 0.2, 'x': 0.2   });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 1, 'g': 0, 'b': 0 });
            this.setAnimationTarget(12, { 'r': 0.4, 'g': 0.4, 'b': 0.4 });

         }

         /*
         this.beamMeshR.visible = true;
         this.beamMeshL.visible = true;
         this.ringBackgroundMesh.visible = true;
         this.backgroundMat.side = THREE.DoubleSide;
         this.lightL.visible = true;
         this.lightR.visible = true;
         this.rotatingRing = false;
         */

      };

      function setProgress( percent, text ) {
         percent = Math.round(percent);
         $("#loading").removeClass('error');
         $("#progressbar-value").css({ 'width': percent + '%' });
         $("#loading-text").html(text);
         $("#loading-percent").html( percent + "%" );
      }

      function setError( text ) {
         $("#loading").addClass('error');
         $("#progressbar-value").css({ 'width': '100%' });
         $("#loading-text").html(text);
         $("#loading-percent").html("");
      }

      function setText( text ) {
         $("#loading").removeClass('error');
         $("#progressbar-value").css({ 'width': '100%' });
         $("#loading-text").html(text);
         $("#loading-percent").html("");
      }

      var lhc;

      /**
       * Entry point function
       *
       * --- Progress events ---
       *
       * [00 - 40%] : Setting up environment
       *        10  : Plugin Ready
       *     10-40  : Downloading/Installing hypervisor
       *
       * [40 - 80%] : Open session
       */

      var inited = false;
      $(document).ready(function() {
         if (inited) return; inited = true;

         // Setup Three.js Viewport
         var v = new M.Viewport({
            container: "#collider",
            bg: 0x000000, //0x202020, 0xf5f5f5,
            autostop: false,
            fullscreen: false,
            stats: false
         });

         v.renderer.sortObjects = false;

         // Setup accelerator ring
         lhc = new AcceleratorRing( v.camera );
         v.scene.add(lhc);

         // Receive render updates to the accelerator ring
         v.addUpdateHandler( lhc.update.bind(lhc) );

         /// INITIALIZE UI ///
         setProgress(0, "Setting up environment");
         lhc.setView(0);

         CVM.debugLogging = true;
         CVM.markPageLoaded();

         // Installation events are only between 10-20%
         CVM.addInstallProgressHandler(function(percent, msg) {
            var value = percent * 30 / 100;
            setProgress(10 + value, msg);
            console.log("InstallProgress = ", 10+value);
         });

         // Initialize CernVM
         CVM.startCVMWebAPI(
            function(plugin) {
               setProgress(20, "Establishing session");

               // Plugin progress events (session itialization are between 20 and 60)
               plugin.addEventListener('progress', function(percent, msg) {
                  var value = percent * 40 / 100;
                  setProgress(40 + value, msg);
                  console.log("pluginProgress = ", 40 + value);
               });

               // Start session
               plugin.requestSession( 'http://test.local/VirtualAtomSmasher/sign.php', function(session) {

                  window.s = session;

                  // Session progress events (session open/resume are between 80 and 100)
                  session.addEventListener('progress', function(percent, msg) {
                     var value = percent * 20 / 100;
                     setProgress(80 + value, msg);
                     console.log("sessionProgress = ", 80 + value);
                  });

                  session.addEventListener('error', function(msg) {
                     lhc.setView(3);
                     setError( msg );
                  });

                  session.addEventListener('open', function() {
                     setText("Preparing your accelerator");
                     lhc.setView(1);
                  });

                  session.addEventListener('start', function() {
                     setText("Preparing your accelerator");
                     lhc.setView(1);
                  });

                  session.addEventListener('stop', function() {
                     setText("Your accelerator is closed");
                     lhc.setView(0);
                  });

                  session.addEventListener('apiAvailable', function() {
                     lhc.setView(2);
                  });

                  session.addEventListener('apiUnavailable', function() {
                     setText("Preparing your accelerator");
                     lhc.setView(1);
                  });

                  // Handle various session states
                  if (session.state == 2) {

                     // OPEN -> START
                     session.start();

                  } else if ((session.state == 3) || (session.state == 4)) {

                     // STARTED(-ING) -> Update view
                     lhc.setView(1);
                     setText("Preparing your accelerator");

                  }


               }, function (err_msg) {

                  // Could not request session
                  lhc.setView(3);
                  setError( err_msg );

               });

            },
            function(e) {
               lhc.setView(3);
               setError(e);
            },
            
            // Let the plugin initialize the environment
            true
         );
         
      });
      
      </script>
      <style type="text/css">
      body {
         overflow: hidden;
         background: #000;
         color: #999;
      }
      #collider {
         position: absolute;
         left: 0px; top: 50%;
         width: 100%; height: 250px;
         margin-top: -125px;
      }
      #loading {
         position: absolute;
         display: block;
         left: 0px; width: 100%;
         top: 50%; height: 50px;
         padding-top: 50px;
      }
      div#loading-message {
         width: 250px;
         margin: auto;
         margin-top: 5px;
         font-family: 'Armata', sans-serif;
         font-size: 10px;
      }
      div#loading-message > span#loading-percent {
         float: right;
         opacity: 0.5;
      }
      div#progressbar {
         margin: auto;
         width: 250px;
         border-top: solid 1px #fff;
      }
      div#progressbar > div#progressbar-value {
         height: 3px;
         display: block;
         background: #fff;
      }

      div#loading.error span { color: #f00; }
      div#loading.error div#progressbar { border-top: solid 1px #f00; }
      div#loading.error div#progressbar-value { background: #f00; }

      div#upper-controls {
         height: 35%;
         position: absolute;
         left: 0px;
         top: 0px;
         width: 100%;
      }

      div#lower-controls {
         height: 35%;
         position: absolute;
         left: 0px;
         bottom: 0px;
         width: 100%;
      }
      </style>
   </head>
   <body>
      <div id="collider"></div>
      <div id="loading">
         <div id="progressbar">
            <div id="progressbar-value"></div>
         </div>
         <div id="loading-message">
            <span id="loading-text">Initializing</span>
            <span id="loading-percent">10%</span>
         </div>
      </div>
      <div id="upper-controls">
      </div>
      <div id="lower-controls">
         <!--
         <a href="javascript:lhc.setView(0)" class="btn btn-inverse">Setting Up</a>
         <a href="javascript:lhc.setView(1)" class="btn btn-inverse">Preparing</a>
         <a href="javascript:lhc.setView(2)" class="btn btn-inverse">Running</a>
         <a href="javascript:lhc.setView(3)" class="btn btn-danger">Error</a>
         -->
      </div>

   </body>
</html>