<!DOCTYPE html>
<html>
   <head>
      <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
      <script type="text/javascript" src="js/three.min.js"></script>
      <script type="text/javascript" src="js/stats.min.js"></script>
      <script type="text/javascript" src="js/tween.js"></script>
      <script type="text/javascript" src="js/smasher.js.php"></script>
      <script type="text/javascript" src="js/shaders/BeamShader.js"></script>
      <script type="text/javascript" src="js/shaders/CollisionShader.js"></script>
      <script type="text/javascript" src="theme/bootstrap/bootstrap.min.js"></script>
      <script type="text/javascript" src="http://code.createjs.com/tweenjs-0.4.1.min.js"></script>
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/darkstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap-responsive.min.css" />
      <link href='http://fonts.googleapis.com/css?family=Armata' rel='stylesheet' type='text/css'>

      <script type="text/javascript">
      
      var Easing = {
         easeInQuad: function (x, t, b, c, d) {
            return c*(t/=d)*t + b;
         },
         easeOutQuad: function (x, t, b, c, d) {
            return -c *(t/=d)*(t-2) + b;
         },
         easeInOutQuad: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t + b;
            return -c/2 * ((--t)*(t-2) - 1) + b;
         },
         easeInCubic: function (x, t, b, c, d) {
            return c*(t/=d)*t*t + b;
         },
         easeOutCubic: function (x, t, b, c, d) {
            return c*((t=t/d-1)*t*t + 1) + b;
         },
         easeInOutCubic: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t + b;
            return c/2*((t-=2)*t*t + 2) + b;
         },
         easeInQuart: function (x, t, b, c, d) {
            return c*(t/=d)*t*t*t + b;
         },
         easeOutQuart: function (x, t, b, c, d) {
            return -c * ((t=t/d-1)*t*t*t - 1) + b;
         },
         easeInOutQuart: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
            return -c/2 * ((t-=2)*t*t*t - 2) + b;
         },
         easeInQuint: function (x, t, b, c, d) {
            return c*(t/=d)*t*t*t*t + b;
         },
         easeOutQuint: function (x, t, b, c, d) {
            return c*((t=t/d-1)*t*t*t*t + 1) + b;
         },
         easeInOutQuint: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
            return c/2*((t-=2)*t*t*t*t + 2) + b;
         },
         easeInSine: function (x, t, b, c, d) {
            return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
         },
         easeOutSine: function (x, t, b, c, d) {
            return c * Math.sin(t/d * (Math.PI/2)) + b;
         },
         easeInOutSine: function (x, t, b, c, d) {
            return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
         },
         easeInExpo: function (x, t, b, c, d) {
            return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
         },
         easeOutExpo: function (x, t, b, c, d) {
            return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
         },
         easeInOutExpo: function (x, t, b, c, d) {
            if (t==0) return b;
            if (t==d) return b+c;
            if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
            return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
         },
         easeInCirc: function (x, t, b, c, d) {
            return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
         },
         easeOutCirc: function (x, t, b, c, d) {
            return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
         },
         easeInOutCirc: function (x, t, b, c, d) {
            if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
            return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
         },
         easeInElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
         },
         easeOutElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
         },
         easeInOutElastic: function (x, t, b, c, d) {
            var s=1.70158;var p=0;var a=c;
            if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
            if (a < Math.abs(c)) { a=c; var s=p/4; }
            else var s = p/(2*Math.PI) * Math.asin (c/a);
            if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
            return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
         },
         easeInBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158;
            return c*(t/=d)*t*((s+1)*t - s) + b;
         },
         easeOutBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158;
            return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
         },
         easeInOutBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158; 
            if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
            return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
         },
         easeInBounce: function (x, t, b, c, d) {
            return c - Easing.easeOutBounce (x, d-t, 0, c, d) + b;
         },
         easeOutBounce: function (x, t, b, c, d) {
            if ((t/=d) < (1/2.75)) {
               return c*(7.5625*t*t) + b;
            } else if (t < (2/2.75)) {
               return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
            } else if (t < (2.5/2.75)) {
               return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
            } else {
               return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
            }
         },
         easeInOutBounce: function (x, t, b, c, d) {
            if (t < d/2) return Easing.easeInBounce (x, t*2, 0, c, d) * .5 + b;
            return Easing.easeOutBounce (x, t*2-d, 0, c, d) * .5 + c*.5 + b;
         }
      };

      var AcceleratorRing = function( camera ) {
         THREE.Object3D.call( this );

         // Prepare variables
         this.cTime = 0;
         this.ringRotationSpeed = 0;
         this.animations = [];
         this.fxTimer = 0;
         this.fxEasing = Easing.easeOutQuad;
         this.fxDelay = 1000;

         // ============================
         //       Setup Camera
         // ============================

         // We also control the camera because we provide
         // the animation functions to zoom in and out from 
         // the accelerator ring
         this.camera = camera;
         this.camera.rotation.z = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 50;
         this.camera.rotation.y = Math.PI/2 - 0.5;

         this.camera.position.x = -5;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;


         // ============================
         //       Setup Lighting
         // ============================

         var l = new THREE.PointLight( 0xffffff );
         l.position.set(0, 0, 0);
         this.add(l);

         var l2 = new THREE.PointLight( 0x008080, 1, 20 );
         l2.position.set(0, 20, 0);
         l2.visible = false;
         this.add(l2);

         var l3 = this.lightL = new THREE.PointLight( 0x37FFFF, 1, 20 );
         l3.position.set(14, 18, 0);
         l3.visible = false;
         this.add(l3);

         var l4 = this.lightR = new THREE.PointLight( 0xffaa00, 1, 20 );
         l4.position.set(-14, 18, 0);
         l4.visible = false;
         this.add(l4);

         // ============================
         //    Setup the two beams
         // ============================

         var beamTex1 = THREE.ImageUtils.loadTexture( 'theme/img/beam-1.png' );
         beamTex1.wrapS = THREE.RepeatWrapping;
         beamTex1.wrapT = THREE.RepeatWrapping;

         var beamTex2 = THREE.ImageUtils.loadTexture( 'theme/img/beam-2.png' );
         beamTex2.wrapS = THREE.RepeatWrapping;
         beamTex2.wrapT = THREE.RepeatWrapping;

         var beamShader = BeamShader;
         var beamShaderUniforms1 = this.beamShaderUniformsL = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms2 = this.beamShaderUniformsR = THREE.UniformsUtils.clone( beamShader.uniforms );
         
         beamShaderUniforms2['tTexture1'].value = beamTex1;
         beamShaderUniforms2['tTexture2'].value = beamTex2;
         beamShaderUniforms1['tTexture1'].value = beamTex1;
         beamShaderUniforms1['tTexture2'].value = beamTex2;
         
         beamShaderUniforms2['uColor'].value = new THREE.Color( 0xffaa00 );
         beamShaderUniforms1['uColor'].value = new THREE.Color( 0x37FFFF ); //0x6666FF
         
         var beamMaterial2 = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms2,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.DoubleSide
         } );
         
         var beamMaterial1 = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms1,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.DoubleSide
         } );

         var beamGeom = new THREE.TorusGeometry( 20, 1.2, 20, 20, Math.PI );

         var beamMesh1 = this.beamMeshL = new THREE.Mesh( beamGeom, beamMaterial1 );
         beamMesh1.rotation.z = 0;
         beamMesh1.visible = false;
         this.add( beamMesh1 );

         var beamMesh2 = this.beamMeshR = new THREE.Mesh( beamGeom, beamMaterial2 );
         beamMesh2.rotation.z = -Math.PI;
         beamMesh2.visible = false;
         this.add( beamMesh2 );

         // ============================
         //  Setup the ring wireframes
         // ============================

         var backgroundMat = this.backgroundMat = new THREE.MeshPhongMaterial({ side: THREE.BackSide, transparent: true, color: 0x999999, opacity: 0.4 });
         var wireframeMat  = this.wireframeMat = new THREE.MeshPhongMaterial({ wireframe: true, side: THREE.BackSide, color: 0xffffff });

         var ringBackgroundGeom = new THREE.TorusGeometry( 20, 3, 10, 20, Math.PI );
         var ringBackgroundMesh = this.ringBackgroundMesh = new THREE.Mesh( ringBackgroundGeom, backgroundMat );
         ringBackgroundMesh.rotation.z = Math.PI/2;
         ringBackgroundMesh.visible = false;
         this.add( ringBackgroundMesh );

         var ringOutlineGeom = new THREE.TorusGeometry( 20, 3.1, 15, 25, Math.PI *2 );
         var ringOutlineMesh = this.ringOutlineMesh = new THREE.Mesh( ringOutlineGeom, wireframeMat );
         this.add( ringOutlineMesh );

         // ===============================
         //  Setup the collision animation
         // ===============================

         var clsnFlareTex1 = THREE.ImageUtils.loadTexture( "theme/img/collision-1.png" );
         var clsnFlareTex2 = THREE.ImageUtils.loadTexture( "theme/img/collision-2.png" );

         var flareColor = 0xD1FCEE ; //0xFFBD9D;
         var collisionMaterial1 = this.collisionMaterial1 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial2 = this.collisionMaterial2 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial3 = this.collisionMaterial3 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );

         var collisionSprite1 = this.collisionSprite1 = new THREE.Sprite( collisionMaterial1 );
         collisionSprite1.position.set( 0, 19, 0 );
         collisionSprite1.position.normalize();
         collisionSprite1.position.multiplyScalar( 1 );
         collisionSprite1.scale.set( 1, 1, 1 );
         collisionSprite1.visible = false;
         this.add( collisionSprite1 );

         var collisionSprite2 = this.collisionSprite2 = new THREE.Sprite( collisionMaterial2 );
         collisionSprite2.position = collisionSprite1.position;
         collisionSprite2.visible = false;
         this.add( collisionSprite2 );

         var collisionSprite3 = this.collisionSprite3 = new THREE.Sprite( collisionMaterial3 );
         collisionSprite3.visible = false;
         collisionSprite3.position = collisionSprite1.position;
         this.add( collisionSprite3 );

         // ===============================
         //   Prepare useful functions
         // ===============================

         // Target values for various animation parameters
         this.animationTargets = [
            {
               'object': this.camera.position,
               'target': new THREE.Vector3( 0, 0, 0 ),
               'source': this.camera.position.clone(),
               'vars'  : ['x','y','z']
            },
         ];

         /**
          * This function returns an animation cycle: for the collision flare
          * 0.0 - 0.2 => { scale: 0.0 - 0.2, opacity: 0.0 - 1.0 },
          * 0.2 - 0.8 => { scale: 0.2 - 1.0, opacity: 1.0 },
          * 0.8 - 1.0 => { scale: 1.1 - 1.8, opacity: 1.0 - 0.0 }
          */
         this.fxCycle = function(v, maxScale) {
            if (maxScale == undefined) maxScale = 1.0;
            if (v < 0.2) {
               v = v/0.2;
               return { 
                  's':   (v * 0.2) * maxScale,
                  'o': v
               };
            } else if (v < 0.8) {
               v = (v-0.2)/0.6;
               return { 
                  's':   (0.2 + v*0.8) * maxScale,
                  'o': 1.0
               };
            } else {
               v = (v-0.8)/0.2;
               return { 
                  's':   (1.0 + v*0.2) * maxScale,
                  'o': 1.0 - v
               };
            }
         }

      }

      AcceleratorRing.prototype = Object.create( THREE.Object3D.prototype );

      /**
       * Update state/animation of the LHC Ring
       */
      AcceleratorRing.prototype.update = function(delta) {

            // Update current time for the animations
            this.cTime += delta / 3000;
            this.fxTimer += delta;

            // Update the beam animation 
            this.beamShaderUniformsL['uTime'].value -= delta/1000;
            this.beamShaderUniformsR['uTime'].value += delta/1000;

            // Update the sprite animation
            this.collisionSprite1.rotation += delta / 7000;
            this.collisionSprite2.rotation -= delta / 8000;
            this.collisionSprite3.rotation -= delta / 5000;
            var fx = this.fxCycle( this.cTime % 1.0, 0.7 );
            this.collisionSprite1.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial1.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.33333) % 1.0, 0.7 );
            this.collisionSprite2.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial2.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.66666) % 1.0, 0.7 );
            this.collisionSprite3.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial3.opacity = fx.o;

            // Rotate the wireframe
            if (this.ringRotationSpeed != 0)
               ringOutlineMesh.rotation.z += delta * this.ringRotationSpeed / 1000;

            // Update animations
            if (this.fxTimer <= this.fxDelay) {
               for (var i=0; i<this.animationTargets.length; i++) {
                  var o = this.animationTargets[i].object,
                      s = this.animationTargets[i].source,
                      t = this.animationTargets[i].target,
                      v = this.animationTargets[i].vars;
                  for (var j=0; j<v.length; v++) {
                     o[v[j]] = this.fxEasing(null, this.fxTimer, s[v[j]], t[v[j]], this.fxDelay);
                  }
               }
            }

      };

      /**
       * Update the current view of the ring
       */
      AcceleratorRing.prototype.setView = function(view) {

         if (view == 0) {

            this.camera.position.x = 100;
            this.camera.position.z = 0;
            this.camera.rotation.y = Math.PI/2;

         } else if (view == 1) {

            this.camera.position.x = -5;
            this.camera.position.z = 0;
            this.camera.rotation.y = Math.PI/2;

         } else if (view == 2) {

            this.camera.position.x = 100;
            this.camera.position.z = 50;
            this.camera.rotation.y = Math.PI/2 - 0.5;
         }

         this.collisionSprite1.visible = true;
         this.collisionSprite2.visible = true;
         this.collisionSprite3.visible = true;
         this.beamMeshR.visible = true;
         this.beamMeshL.visible = true;
         this.ringBackgroundMesh.visible = true;
         this.backgroundMat.side = THREE.DoubleSide;
         this.lightL.visible = true;
         this.lightR.visible = true;
         this.rotatingRing = false;

      };

      $(function() {
         
         var v = new M.Viewport({
            container: "#collider",
            bg: 0x000000, //0x202020, 0xf5f5f5,
            autostop: true,
            fullscreen: false,
            stats: false
         });

         v.renderer.sortObjects = true;

         var lhc = new AcceleratorRing( v.camera );
         v.scene.add(lhc);
         window.lhc = lhc;

         /*
         v.camera.position.set  ( 0, 0, 0 );
         v.camera.lookAt(new THREE.Vector3( 0, 1, 0 ));
         v.camera.rotation.z = Math.PI;
         */

         window.v = v;
         /*
         v.camera.position.set  ( 0, -100, 0 );
         v.camera.lookAt(new THREE.Vector3( 0, 0, 0 ));
         v.camera.rotation.z = Math.PI;
         */

         /*
         $(document.body).mousemove(function(e) {
            var y = (e.clientY / $(window).height()) - 0.5;
            var x = (e.clientX / $(window).width()) - 0.5;
            v.camera.position.z = y * 5;
            v.camera.position.x = x * 5;
            v.camera.lookAt(new THREE.Vector3( 0, 20, 0 ));
         })
         */

         lhc.setView();

         v.render = function( delta ) {
            M.Viewport.prototype.render.call(this, delta);
            lhc.update( delta );
         };
         
      });
      
      </script>
      <style type="text/css">
      body {
         overflow: hidden;
         background: #000;
         color: #999;
      }
      #collider {
         position: absolute;
         left: 0px; top: 50%;
         width: 100%; height: 250px;
         margin-top: -125px;
      }
      #loading {
         position: absolute;
         display: block;
         left: 0px; width: 100%;
         top: 50%; height: 50px;
         padding-top: 50px;
      }
      div#loading-message {
         width: 250px;
         margin: auto;
         margin-top: 5px;
         font-family: 'Armata', sans-serif;
         font-size: 10px;
      }
      div#loading-message > span#loading-percent {
         float: right;
         opacity: 0.5;
      }
      div#progressbar {
         margin: auto;
         width: 250px;
         border-top: solid 1px #fff;
      }
      div#progressbar > div#progressbar-value {
         height: 3px;
         display: block;
         background: #fff;
         width: 10%;
      }

      </style>
   </head>
   <body>
      <div id="collider"></div>
      <div id="loading">
         <div id="progressbar">
            <div id="progressbar-value"></div>
         </div>
         <div id="loading-message">
            <span id="loading-text">Initializing</span>
            <span id="loading-percent">10%</span>
         </div>
         <div><a href="#" class="btn btn-inverse">Test</a></div>
      </div>
   </body>
</html>