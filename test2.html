<!DOCTYPE html>
<html>
   <head>
      <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
      <script type="text/javascript" src="js/three.min.js"></script>
      <script type="text/javascript" src="js/stats.min.js"></script>
      <script type="text/javascript" src="js/smasher.js.php"></script>
      <script type="text/javascript" src="js/shaders/BeamShader.js"></script>
      <script type="text/javascript" src="js/shaders/CollisionShader.js"></script>
      <script type="text/javascript" src="js/jquery.easing.1.3.js"></script>
      <script type="text/javascript" src="js/md5.js"></script>
      <script type="text/javascript" src="http://cernvm.cern.ch/releases/webapi/js/cvmwebapi-1.3.js"></script>
      <script type="text/javascript" src="theme/bootstrap/bootstrap.min.js"></script>
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/darkstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="theme/bootstrap/bootstrap-responsive.min.css" />
      <link href='http://fonts.googleapis.com/css?family=Armata' rel='stylesheet' type='text/css'>

      <script type="text/javascript">
      
      var AcceleratorRing = function( camera ) {
         THREE.Object3D.call( this );

         // Prepare variables
         this.cTime = 0;
         this.animations = [];
         this.fxTimer = 0;
         this.fxEasing = jQuery.easing.easeOutQuad;
         this.fxDelay = 1000;
         this.fxCompleteCb = null;

         // Animation variables
         this.ringRotationSpeed = 0;
         this.collisionOpacity = 0;

         // ============================
         //       Setup Camera
         // ============================

         // We also control the camera because we provide
         // the animation functions to zoom in and out from 
         // the accelerator ring
         this.camera = camera;
         this.camera.rotation.z = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 50;
         this.camera.rotation.y = Math.PI/2 - 0.5;

         this.camera.position.x = -5;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;

         this.camera.position.x = 100;
         this.camera.position.z = 0;
         this.camera.rotation.y = Math.PI/2;


         // ============================
         //       Setup Lighting
         // ============================

         var l = new THREE.PointLight( 0xffffff );
         l.position.set(0, 0, 0);
         this.add(l);

         var l2 = this.lightM = new THREE.PointLight( 0x008080, 0, 20 );
         l2.position.set(0, -15, 0);
         this.add(l2);

         var l3 = this.lightR = new THREE.PointLight( 0x37FFFF, 0, 20 ); //20 );
         l3.position.set(-13, 7.5, 0);
         this.add(l3);

         var l4 = this.lightL = new THREE.PointLight( 0xffaa00, 0, 20 );
         l4.position.set(-13, -7.5, 0);
         this.add(l4);

         // ============================
         //    Setup the two beams
         // ============================

         var beamTex1 = THREE.ImageUtils.loadTexture( 'theme/img/beam-1b.png' );
         beamTex1.wrapS = THREE.RepeatWrapping;
         beamTex1.wrapT = THREE.RepeatWrapping;

         var beamTex2 = THREE.ImageUtils.loadTexture( 'theme/img/beam-2b.png' );
         beamTex2.wrapS = THREE.RepeatWrapping;
         beamTex2.wrapT = THREE.RepeatWrapping;

         var beamShader = BeamShader;
         var beamShaderUniforms2f = this.beamShaderUniformsLf = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms1f = this.beamShaderUniformsRf = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms2b = this.beamShaderUniformsLb = THREE.UniformsUtils.clone( beamShader.uniforms );
         var beamShaderUniforms1b = this.beamShaderUniformsRb = THREE.UniformsUtils.clone( beamShader.uniforms );
         
         beamShaderUniforms2f['tTexture1'].value = beamTex1;
         beamShaderUniforms2f['tTexture2'].value = beamTex2;
         beamShaderUniforms1f['tTexture1'].value = beamTex1;
         beamShaderUniforms1f['tTexture2'].value = beamTex2;
         beamShaderUniforms2b['tTexture1'].value = beamTex1;
         beamShaderUniforms2b['tTexture2'].value = beamTex2;
         beamShaderUniforms1b['tTexture1'].value = beamTex1;
         beamShaderUniforms1b['tTexture2'].value = beamTex2;
         
         beamShaderUniforms2f['uColor'].value = new THREE.Color( 0xffaa00 );
         beamShaderUniforms1f['uColor'].value = new THREE.Color( 0x37FFFF ); //0x6666FF
         beamShaderUniforms2b['uColor'].value = new THREE.Color( 0xffaa00 );
         beamShaderUniforms1b['uColor'].value = new THREE.Color( 0x37FFFF ); //0x6666FF
         
         var beamMaterial2f = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms2f,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.FrontSide
         } );

         var beamMaterial2b = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms2b,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.BackSide
         } );
         

         var beamMaterial1f = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms1f,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.FrontSide
         } );

         var beamMaterial1b = new THREE.ShaderMaterial( {
            uniforms: beamShaderUniforms1b,
            vertexShader: beamShader.vertexShader,
            fragmentShader: beamShader.fragmentShader,
            transparent: true,
            side: THREE.BackSide
         } );

         var beamGeom = new THREE.TorusGeometry( 20, 1.2, 20, 20, Math.PI );


         var beamMesh1b = this.beamMeshLb = new THREE.Mesh( beamGeom, beamMaterial1b );
         beamMesh1b.rotation.z = 0;
         beamMesh1b.rotation.y = Math.PI;
         this.add( beamMesh1b );

         var beamMesh1f = this.beamMeshLf = new THREE.Mesh( beamGeom, beamMaterial1f );
         beamMesh1f.rotation.z = 0;
         beamMesh1f.rotation.y = Math.PI;
         this.add( beamMesh1f );

         var beamMesh2b = this.beamMeshRb = new THREE.Mesh( beamGeom, beamMaterial2b );
         beamMesh2b.rotation.z = -Math.PI;
         this.add( beamMesh2b );

         var beamMesh2f = this.beamMeshRf = new THREE.Mesh( beamGeom, beamMaterial2f );
         beamMesh2f.rotation.z = -Math.PI;
         this.add( beamMesh2f );

         // ============================
         //  Setup the ring wireframes
         // ============================

         var backgroundMat = this.backgroundMat = new THREE.MeshPhongMaterial({ side: THREE.FrontSide, transparent: true, color: 0x000000, opacity: 0.4 });
         var wireframeMat  = this.wireframeMat = new THREE.MeshPhongMaterial({ wireframe: true, side: THREE.BackSide, color: 0x000000 });

         var ringBackgroundGeom = new THREE.TorusGeometry( 20, 3, 10, 20, Math.PI );
         var ringBackgroundMesh = this.ringBackgroundMesh = new THREE.Mesh( ringBackgroundGeom, backgroundMat );
         ringBackgroundMesh.rotation.z = Math.PI/2;
         this.add( ringBackgroundMesh );

         var ringOutlineGeom = new THREE.TorusGeometry( 20, 3.1, 18, 25, Math.PI *2 );
         var ringOutlineMesh = this.ringOutlineMesh = new THREE.Mesh( ringOutlineGeom, wireframeMat );
         this.add( ringOutlineMesh );

         // ===============================
         //  Setup the collision animation
         // ===============================

         var clsnFlareTex1 = THREE.ImageUtils.loadTexture( "theme/img/collision-1.png" );
         var clsnFlareTex2 = THREE.ImageUtils.loadTexture( "theme/img/collision-2.png" );

         var flareColor = 0xD1FCEE ; //0xFFBD9D;
         var collisionMaterial1 = this.collisionMaterial1 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial2 = this.collisionMaterial2 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );
         var collisionMaterial3 = this.collisionMaterial3 = new THREE.SpriteMaterial( { map: clsnFlareTex1, useScreenCoordinates: false, color: flareColor, fog: true } );

         var collisionSprite1 = this.collisionSprite1 = new THREE.Sprite( collisionMaterial1 );
         collisionSprite1.position.set( -15, 0, 0 );
         collisionSprite1.scale.set( 100, 100, 100 );
         this.add( collisionSprite1 );

         var collisionSprite2 = this.collisionSprite2 = new THREE.Sprite( collisionMaterial2 );
         collisionSprite2.position = collisionSprite1.position.clone();
         collisionSprite2.scale = collisionSprite1.scale.clone();
         this.add( collisionSprite2 );

         var collisionSprite3 = this.collisionSprite3 = new THREE.Sprite( collisionMaterial3 );
         collisionSprite3.position = collisionSprite1.position.clone();
         collisionSprite3.scale = collisionSprite1.scale.clone();
         this.add( collisionSprite3 );

         // ===============================
         //   Prepare useful functions
         // ===============================

         // Target values for various animation parameters
         this.animationTargets = [
            {
               'o': this.camera.position,             // Object
               't': this.camera.position.clone(),     // Target 
               's': this.camera.position.clone(),     // Source
               'v'  : ['x','y','z']                   // Value names
            },
            {
               'o': this.camera.rotation,
               't': this.camera.rotation.clone(),
               's': this.camera.rotation.clone(),
               'v'  : ['x','y','z']
            },
            {
               'o': this,
               't': { 'ringRotationSpeed': 0, 'collisionOpacity': 0 },
               's': { 'ringRotationSpeed': 0, 'collisionOpacity': 0 },
               'v'  : [ 'ringRotationSpeed', 'collisionOpacity' ]
            },
            {
               'o': this.lightL,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': this.lightR,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': this.lightM,
               't': { 'intensity': 0 },
               's': { 'intensity': 0 },
               'v'  : ['intensity']
            },
            {
               'o': beamShaderUniforms1f['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms1b['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms2f['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': beamShaderUniforms2b['uOpacity'],
               't': { 'value': 0 },
               's': { 'value': 0 },
               'v'  : ['value']
            },
            {
               'o': this.backgroundMat,
               't': { 'opacity': 0 },
               's': { 'opacity': 0 },
               'v': [ 'opacity' ]
            },
            {
               'o': this.wireframeMat.color,
               't': new THREE.Color(0,0,0),
               's': new THREE.Color(0,0,0),
               'v': [ 'r','g','b' ]
            },
            {
               'o': this.wireframeMat.emissive,
               't': new THREE.Color(0,0,0),
               's': new THREE.Color(0,0,0),
               'v': [ 'r','g','b' ]
            }
         ];

         this.setAnimationTarget = function(index, vars) {
            $.each(vars, (function(k,v) {
               this.animationTargets[index].s[k] = this.animationTargets[index].o[k];
               this.animationTargets[index].t[k] = v;
            }).bind(this));
         }

         /**
          * This function returns an animation cycle: for the collision flare
          * 0.0 - 0.2 => { scale: 0.0 - 0.2, opacity: 0.0 - 1.0 },
          * 0.2 - 0.8 => { scale: 0.2 - 1.0, opacity: 1.0 },
          * 0.8 - 1.0 => { scale: 1.1 - 1.8, opacity: 1.0 - 0.0 }
          */
         this.fxCycle = function(v, maxScale, maxOpacity) {
            if (maxScale == undefined) maxScale = 1.0;
            if (maxOpacity == undefined) maxOpacity = 1.0;
            if (v < 0.2) {
               v = v/0.2;
               return { 
                  's':   (v * 0.2) * maxScale,
                  'o': v * maxOpacity
               };
            } else if (v < 0.8) {
               v = (v-0.2)/0.6;
               return { 
                  's':   (0.2 + v*0.8) * maxScale,
                  'o': 1.0 * maxOpacity
               };
            } else {
               v = (v-0.8)/0.2;
               return { 
                  's':   (1.0 + v*0.2) * maxScale,
                  'o': (1.0 - v) * maxOpacity
               };
            }
         }
      }

      AcceleratorRing.prototype = Object.create( THREE.Object3D.prototype );


      /**
       * Update animation callback
       */
      AcceleratorRing.prototype.onAnimationCompleted = function(cb) {
         this.fxCompleteCb = cb;
      };

      /**
       * Update the beam colors
       */
      AcceleratorRing.prototype.setBeamColors = function( left, right, collision ) {
         this.lightL.color.setHex( left );
         this.beamShaderUniformsLf['uColor'].value.setHex( left );
         this.beamShaderUniformsLb['uColor'].value.setHex( left );

         this.lightR.color.setHex( right );
         this.beamShaderUniformsRf['uColor'].value.setHex( right );
         this.beamShaderUniformsRb['uColor'].value.setHex( right );

         if (collision == undefined) collision = left | right;

         this.collisionMaterial1.color.setHex( collision );
         this.collisionMaterial2.color.setHex( collision );
         this.collisionMaterial3.color.setHex( collision );

      };

      /**
       * Update state/animation of the LHC Ring
       */
      AcceleratorRing.prototype.update = function(delta) {

            // Update current time for the animations
            this.cTime += delta / 3000;

            // Update the beam animation 
            this.beamShaderUniformsLf['uTime'].value += delta/1000;
            this.beamShaderUniformsRf['uTime'].value += delta/1000;
            this.beamShaderUniformsLb['uTime'].value += delta/1000;
            this.beamShaderUniformsRb['uTime'].value += delta/1000;

            // Update the sprite animation
            this.collisionSprite1.rotation += delta / 7000;
            this.collisionSprite2.rotation -= delta / 8000;
            this.collisionSprite3.rotation -= delta / 5000;
            var fx = this.fxCycle( this.cTime % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite1.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial1.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.33333) % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite2.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial2.opacity = fx.o;
            fx = this.fxCycle( (this.cTime + 0.66666) % 1.0, 10.0, this.collisionOpacity );
            this.collisionSprite3.scale.set( fx.s, fx.s, fx.s );
            this.collisionMaterial3.opacity = fx.o;

            // Rotate the wireframe
            if (this.ringRotationSpeed != 0)
               this.ringOutlineMesh.rotation.z += delta * this.ringRotationSpeed / 1000;

            // Update animations
            if (this.fxTimer < this.fxDelay) {

               // Wrap to max
               this.fxTimer += delta;
               if (this.fxTimer > this.fxDelay) this.fxTimer = this.fxDelay;

               // Animation cycle over each object's variables
               for (var i=0; i<this.animationTargets.length; i++) {
                  var o = this.animationTargets[i].o,
                      s = this.animationTargets[i].s,
                      t = this.animationTargets[i].t,
                      v = this.animationTargets[i].v;
                  for (var j=0; j<v.length; j++) {
                     if (typeof(s) == 'number') {
                        o[v[j]] = this.fxEasing(null, this.fxTimer, s, t-s, this.fxDelay);
                     } else {
                        o[v[j]] = this.fxEasing(null, this.fxTimer, s[v[j]], t[v[j]] - s[v[j]], this.fxDelay);
                     }
                  }
               }

               // Check for completion
               if ((this.fxTimer == this.fxDelay) && (this.fxCompleteCb != undefined))
                  this.fxCompleteCb();

            }

      };

      /**
       * Update the current view of the ring
       */
      AcceleratorRing.prototype.setView = function(view) {

         this.fxTimer = 0;
         this.view = view;

         if (view == 0) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 0 });
            this.setAnimationTarget(1, { 'y': Math.PI/2, 'x': 0   });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 0.5, 'g': 0.5, 'b': 0.5 });
            this.setAnimationTarget(12, { 'r': 0.4, 'g': 0.4, 'b': 0.4 });

         } else if (view == 1) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 40 });
            this.setAnimationTarget(1, { 'y': Math.PI/2 - 0.45, 'x': 0 });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 1,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 0.8, 'g': 0.8, 'b': 0.8 });
            this.setAnimationTarget(12, { 'r': 0.1, 'g': 0.1, 'b': 0.1 });

         } else if (view == 2) {

            this.setAnimationTarget(0, { 'x': -5, 'z': 0 });
            this.setAnimationTarget(1, { 'y': Math.PI/2, 'x': 0 });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 1
            });

            this.setAnimationTarget(3, { 'intensity': 1 });
            this.setAnimationTarget(4, { 'intensity': 1 });
            this.setAnimationTarget(5, { 'intensity': 1 });

            this.setAnimationTarget(6, { 'value': 1 });
            this.setAnimationTarget(7, { 'value': 0.5 });
            this.setAnimationTarget(8, { 'value': 1 });
            this.setAnimationTarget(9, { 'value': 0.5 });

            this.setAnimationTarget(10, { 'opacity': 0.4 });

            this.setAnimationTarget(11, { 'r': 0.2, 'g': 0.2, 'b': 0.2 });
            this.setAnimationTarget(12, { 'r': 0.2, 'g': 0.2, 'b': 0.2 });

         } else if (view == 3) {

            this.setAnimationTarget(0, { 'x': 100, 'z': 20 });
            this.setAnimationTarget(1, { 'y': Math.PI/2 - 0.2, 'x': 0.2   });
            this.setAnimationTarget(2, { 
               'ringRotationSpeed': 0,
               'collisionOpacity': 0
            });

            this.setAnimationTarget(3, { 'intensity': 0 });
            this.setAnimationTarget(4, { 'intensity': 0 });
            this.setAnimationTarget(5, { 'intensity': 0 });

            this.setAnimationTarget(6, { 'value': 0 });
            this.setAnimationTarget(7, { 'value': 0 });
            this.setAnimationTarget(8, { 'value': 0 });
            this.setAnimationTarget(9, { 'value': 0 });

            this.setAnimationTarget(10, { 'opacity': 0 });

            this.setAnimationTarget(11, { 'r': 1, 'g': 0, 'b': 0 });
            this.setAnimationTarget(12, { 'r': 0.4, 'g': 0.4, 'b': 0.4 });

         }

      };

      /**
       * =================================================================
       *  Local Functions for the UI animation
       * =================================================================
       */

      /**
       * Display a rotating progress messages
       */
      var rotatingProgressTimer = 0,
          rotatingActive = false,
          rotatingMessages = [];
      function __resetNestProgress() {
         clearTimeout(rotatingProgressTimer);
         rotatingActive = false;
         rotatingMessages = [];
         rotatingProgressTimer = 0;
      }
      function __showNestProgress() {

         // Make sure we don't have any left-over
         // timer running...
         if (!rotatingActive) return;
         if (rotatingMessages.length == 0) return;

         // Display message
         var msg = rotatingMessages.shift();
         progressMessage(msg, true, true);

         // Reset queue when we are done
         if (rotatingMessages.length == 0) {
            __resetNestProgress();
         } else {
            // Otherwise schedule next tick
            rotatingProgressTimer = setTimeout(__showNestProgress, Math.random() * 5000 + 2000 );
         }
      }

      /**
       * Setup rotating messages
       */
      function progressRotatingMessages( messages ) {

         // Set messages
         rotatingMessages = messages;

         // Start rotation if not active
         if (!rotatingActive) {
            rotatingActive = true;
            __showNestProgress();
         }

      }

      /**
       * Cancel message rotation
       */
      function progressCancelRotating() {
         if (!rotatingActive) return;
         __resetNestProgress();
      }

      /**
       * Roll-in an animating text entry on the progress bar
       */
      var progressCurrentText = "#loading-text-1",
          lastProgressText = "";
      function progressAnimateText( message ) {

         // Do nothing if the last text is excactly the same
         // with the new one
         if (lastProgressText == message) return;
         lastProgressText = message;

         // Fade out the past
         $(progressCurrentText).stop(true, true);
         $(progressCurrentText).animate({
            'opacity': 0
         }, 200);

         // Switch between past and current text messages
         if (progressCurrentText == "#loading-text-1") {
            progressCurrentText = "#loading-text-2";
         } else {
            progressCurrentText = "#loading-text-1";
         }

         // Scroll-in the current
         $(progressCurrentText).stop(true, true);
         $(progressCurrentText).html( message );
         $(progressCurrentText).css({
            'opacity': 0,
            'top': 25
         });
         $(progressCurrentText).animate({
            'opacity': 1,
            'top': 0
         }, 200, 'easeOutExpo');
         
      };

      /**
       * Update progress bar
       */
      function progressUpdate( percent, text ) {
         percent = Math.round(percent);
         progressCancelRotating();
         $("#loading").fadeIn(500);
         $("#loading").removeClass('error');
         $("#progressbar-value").css({ 'width': percent + '%' });
         progressAnimateText(text);
         $("#loading-percent").html( percent + "%" );
      }

      /**
       * Display an error on the progress bar without progress indicator
       */
      function progressError( text ) {
         progressCancelRotating();
         $("#loading").fadeIn(500);
         $("#loading").addClass('error');
         $("#progressbar-value").css({ 'width': '100%' });
         progressAnimateText(text);
         $("#loading-percent").html("");
      }

      /**
       * Display a message on the progress bar without progress indicator
       */
      function progressMessage( text, pending, preserveRotatingMessages ) {
         if (!preserveRotatingMessages) progressCancelRotating();
         $("#loading").fadeIn(500);
         $("#loading").removeClass('error');
         $("#progressbar-value").css({ 'width': '100%' });
         progressAnimateText(text);
         if (!pending) {
            $("#loading-percent").html("");
         } else {
            $("#loading-percent").html("<img src=\"theme/img/ajax-dots.gif\" />");
         }
      }

      function showLaunchControls() {
         $("#launch-controls").fadeIn(500);
      }

      function hideLaunchControls() {
         $("#launch-controls").fadeOut(500, function() {
            $("#launch-controls").hide();
         });
      }

      function showProgress() {
         $("#loading").fadeIn(500);
      }

      function hideProgress() {
         progressCancelRotating();
         $("#loading").fadeOut(500);
      }

      function showDashboard() {
         $("#upper-controls").fadeIn(500);
         $("#lower-controls").fadeIn(500);
      }

      function hideDashboard() {
         $("#upper-controls").fadeOut(500, function() {
            $("#upper-controls").hide();
         });
         $("#lower-controls").fadeOut(500, function() {
            $("#lower-controls").hide();
         });
      }

      function aceleratorStop() {
         v_session.hibernate();
         hideDashboard();
         setTimeout(function() {
            progressMessage("Ramping-down the accelerator", true);
         }, 500);
      }

      function aceleratorCleanup() {
         v_session.close();
         hideDashboard();
         setTimeout(function() {
            progressMessage("Dismantling the accelerator", true);
         }, 500);
      }

      function acceleratorStart() {

         var boincInfo = boincGetInfo();
         if (!boincInfo) {
            v_session.start( localBoincInfo );
         } else {

            // Prepare BOINC string
            var boincStr = "BOINC_USERNAME=" + boincInfo.name + "\n" + 
                           "BOINC_AUTHENTICATOR=" + boincInfo.authenticator + "\n" + 
                           "BOINC_USERID=" + boincInfo.id + "\n";
            console.log("Starting with BOINC_Config", boincStr);
            v_session.start({
               'boinc_config': boincStr
            });
            v_session.setProperty("/boinc/name", boincInfo.name);
            v_session.setProperty("/boinc/id", boincInfo.id);
            v_session.setProperty("/boinc/auth", boincInfo.authenticator);

            // You cannot disconnect now
            $("#boinc-logout").hide();

         }

         hideLaunchControls();
         progressMessage("Ramping-up the accelerator", true);
      }

      function acceleratorRDP( href ) {
         v_session.openRDPWindow();
      }

      function acceleratorOpenRDP() {
         var resolution = v_session.__session.resolution,
             resParts = resolution.split("x");
         var rdpObjectReference = window.open(
            "http://cernvm.cern.ch/releases/webapi/webrdp/webclient.html#" + v_session.rdpURL + "," + resParts[0] + "," + resParts[1] , "cernvmRDP");
         window.w = rdpObjectReference;
      }

      function acceleratorSetRDPURL( a ) {
         var resolution = v_session.__session.resolution,
             resParts = resolution.split("x");
         a.href = "http://cernvm.cern.ch/releases/webapi/webrdp/webclient.html#" + v_session.rdpURL + "," + resParts[0] + "," + resParts[1];
      }

      function acceleratorLogs() {
         var windowObjectReference = window.open(v_session.apiURL + "/logs" , "cernvmLogs");
      }

      /**
       * =================================================================
       *  BOINC-Specific functions
       * =================================================================
       */


      var localBoincInfo = null;
      function boincGetInfo() {
         if (localBoincInfo != null) return localBoincInfo;
         if (!localStorage.getItem("boinc-id")) {
            return false;
         } else {
            return localBoincInfo = {
               id: localStorage.getItem("boinc-id"),
               name: localStorage.getItem("boinc-name"),
               authenticator: localStorage.getItem("boinc-auth")
            };
         }
      }

      function boincLogin() {
         $("#boinc-error-msg").hide();
         $("#boinc-login-form").fadeIn();
      }

      function boincLogout() {
         localBoincInfo = null;
         localStorage.removeItem("boinc-id");
         localStorage.removeItem("boinc-name");
         localStorage.removeItem("boinc-auth");
         boincUpdateStatus( true );
      }

      function boincUpdateStatus( fade ) {
         var bInfo = boincGetInfo();
         if (!bInfo) {
            if (!fade) {
               $("#boinc-login").show();
               $("#boinc-status").hide();
            } else {
               $("#boinc-status").fadeOut(250, function() {
                  $("#boinc-login").fadeIn(250);
               });
            }
         } else {
            $("#boinc-name").html(bInfo.name);
            if (!fade) {
               $("#boinc-login").hide();
               $("#boinc-status").show();
            } else {
               $("#boinc-login").fadeOut(250, function() {
                  $("#boinc-status").fadeIn(250);
               });
            }
         }
      }

      function boincDoLogin() {
         var uEmail = $("#boinc-login-email").val(),
             uPassword = $("#boinc-login-password").val(),
             uRemember = $("#boinc-login-remember").prop("checked");

         $("#boinc-error-msg").hide();
         $("#boinc-login-form input").prop("disabled", true);
         $("#boinc-login-form button").prop("disabled", true);
         $("#boinc-login-submit").html("Loading...");

         var arg_email = escape(uEmail),
             arg_password = md5( uPassword + arg_email.toLowerCase() );

         var boincBaseURL = "http://lhcathome2.cern.ch/test4theory";

         // =============================================================
         // Validate account and get BOINC authenticator
         var jqxhr = $.ajax( {
            url: boincBaseURL+"/lookup_account.php?email_addr="+arg_email+"&passwd_hash="+arg_password+"&get_opaque_auth=1",
            dataType: 'xml'
         })
         // =============================================================
             .done(function( msg ) {
               // Successful response
               if (msg.firstChild.tagName == "error") {
                  $("#boinc-error-msg").html( "Login error: " + msg.getElementsByTagName("error_msg")[0].textContent );
                  $("#boinc-error-msg").fadeIn();
               } else {

                  // We got the authenticator
                  var authenticator = msg.getElementsByTagName("authenticator")[0].textContent;
                  if (!authenticator) {
                     $("#boinc-error-msg").html( "Unable to identify the authenticator" );
                     $("#boinc-error-msg").fadeIn();
                  }

                  // =============================================================
                  // Now try to get more information about the user
                  $.ajax({
                     url: boincBaseURL+"/am_get_info.php?account_key="+authenticator,
                     dataType: 'xml'
                  })
                  // =============================================================
                     .done(function( msg ) {

                        // Handle response
                        if (msg.firstChild.tagName == "error") {
                           $("#boinc-error-msg").html( "User info error: " + msg.getElementsByTagName("error_msg")[0].textContent );
                           $("#boinc-error-msg").fadeIn();
                        } else {

                           // Populate local info
                           localBoincInfo = {

                              'id'           : msg.getElementsByTagName('id')[0].textContent,
                              'name'         : msg.getElementsByTagName('name')[0].textContent,
                              'authenticator': authenticator

                           };

                           // If user clicked remember me, store authenticator in local store
                           // otherwise, clean previous traces.
                           if (uRemember) {
                              localStorage.setItem("boinc-id", localBoincInfo.id);
                              localStorage.setItem("boinc-name", localBoincInfo.name);
                              localStorage.setItem("boinc-auth", localBoincInfo.authenticator);
                           } else {
                              localStorage.removeItem("boinc-id");
                              localStorage.removeItem("boinc-name");
                              localStorage.removeItem("boinc-auth");
                           }

                           // Hide window and upate status
                           $("#boinc-login-form").fadeOut();
                           boincUpdateStatus(true);

                        }

                     }).fail(function( msg ) {
                        // I/O Error
                        $("#boinc-error-msg").html("Connunication error: " + msg);
                        $("#boinc-error-msg").fadeIn();
                     });

               }
             })

             .fail(function( msg ) {
               // I/O Error
               $("#boinc-error-msg").html("Connunication error: " + msg);
               $("#boinc-error-msg").fadeIn();
             })

             .always(function() {
               // In any case, restore the layout
               $("#boinc-login-form input").prop("disabled", false);
               $("#boinc-login-form button").prop("disabled", false);
               $("#boinc-login-submit").html("Login");
             });

      }

      /**
       * =================================================================
       *  Higher-level functions
       * =================================================================
       */

      var lhc, v_session;

      function setPreparingView() {
         lhc.setView(1);
         progressRotatingMessages([

               "Connecting to your instance",

               "Configuring network",
               "Starting critical services",
               "Preparing environment",
               "Preparing accelerator software",

               "Contacting time services",
               "Calibrating timers",

               "Discovering environment",
               "Connecting to controller interface",
               "Connecting to CERN",
               "Authorizing client",
               "Mounting network filesystems",

               "Configuring job manager",

               "Downloading simulator components",
               "Downloading physics configuration",
               "Downloading reference data",

               "Starting work queue",
               "Starting simulator",

               "Probe injection beam",
               "Beam dumped",
               "Physics injection beam",
               "Preparing ramp",
               "Ramping accelerator",
               "Reached flat top",
               "Squeezing beams",
               "Adjusting beams",
               "Stable physics beams",

               "Waiting for physics job"

            ]);
      }


      /**
       * Entry point function
       *
       * --- Progress events ---
       *
       * [00 - 40%] : Setting up environment
       *        10  : Plugin Ready
       *     10-40  : Downloading/Installing hypervisor
       *
       * [40 - 80%] : Open session
       */

      var inited = false,
          isTimeTraveller = false;
      $(document).ready(function() {
         if (inited) return; inited = true;

         // Reset UI
         $("#not-supported-msg").hide();
         $("#upper-controls").hide();
         $("#lower-controls").hide();
         $("#launch-controls").hide();
         $("#boinc-login-form").hide();
         boincUpdateStatus();
         progressUpdate(0, "Setting up environment");
         $("body").removeClass('not-ready');

         // Prepare two functions that start the system after a delay
         // not to completely freeze the browser

         //////////////////////////////////////////////////////////
         function setupWebGL() {
         //////////////////////////////////////////////////////////

            // Check for WebGL Errors
            try {

               // Setup Three.js Viewport
               var v = new M.Viewport({
                  container: "#collider",
                  bg: 0x000000, //0x202020, 0xf5f5f5,
                  autostop: false,
                  fullscreen: false,
                  stats: false
               });

               v.renderer.sortObjects = false;

               // Setup accelerator ring
               lhc = new AcceleratorRing( v.camera );
               v.scene.add(lhc);

               // Receive render updates to the accelerator ring
               v.addUpdateHandler( lhc.update.bind(lhc) );

               // Default view
               lhc.setView(0);

            } catch (e) {

               // WebGL Error
               $("#not-supported-msg").fadeIn();
               $("#loading").hide();

               // The user is from the past
               isTimeTraveller = true;
               return;

            }

         }

         //////////////////////////////////////////////////////////
         function setupCVM() {
         //////////////////////////////////////////////////////////

            CVM.debugLogging = true;

            // Installation events are only between 10-20%
            CVM.addInstallProgressHandler(function(percent, msg) {
               var value = percent * 30 / 100;
               progressUpdate(10 + value, msg);
               console.log("InstallProgress = ", 10+value);
            });

            // Initialize CernVM
            CVM.startCVMWebAPI(
               function(plugin) {
                  progressUpdate(20, "Establishing session");

                  // Plugin progress events (session itialization are between 20 and 60)
                  plugin.addEventListener('progress', function(percent, msg) {
                     var value = percent * 40 / 100;
                     progressUpdate(40 + value, msg);
                     console.log("pluginProgress = ", 40 + value);
                  });

                  // Start session
                  //plugin.requestSession( 'http://labs.wavesoft.gr/t4t/sign.php', function(session) {
                  plugin.requestSession( 'http://test.local/VirtualAtomSmasher/sign.php', function(session) {

                     window.s = session;
                     v_session = session;

                     // Handle various session states
                     if (session.state == 2) {

                        // OPEN -> START
                        showLaunchControls();
                        //session.start();

                     }

                     // Check if this VM is already bound to a BOINC account
                     // (Since we are pausing/resuming the floppy cannot be changed!)
                     var boincUser = session.getProperty("/boinc/name");
                     if (boincUser != "") {

                        // Disable logout
                        $("#boinc-logout").hide();

                        // Update local info too
                        if (localBoincInfo == null) {
                           localBoincInfo = {
                              name: boincUser,
                              id: session.getProperty("/boinc/id"),
                              authenticator: session.getProperty("/boinc/auth")
                           };
                           boincUpdateStatus(false);
                        }
                     }


                     // Session progress events (session open/resume are between 80 and 100)
                     session.addEventListener('progress', function(percent, msg) {
                        var value = percent * 20 / 100;
                        progressUpdate(80 + value, msg);
                        console.log("sessionProgress = ", 80 + value);
                     });

                     session.addEventListener('error', function(msg) {
                        lhc.setView(3);
                        progressError( msg );
                     });

                     session.addEventListener('sessionStateChange', function(newState) {

                        if (newState == 2) { // Open Session
                           progressMessage("Your accelerator is closed");
                           lhc.setView(0);
                           showLaunchControls();
                           hideDashboard();

                        } else if ((newState == 3) || (newState == 4)) { // Started 

                           setPreparingView();
                           hideLaunchControls();
                           hideDashboard();

                        } else if (newState == 6) { // Paused
                           progressMessage("Your accelerator is frozen");
                           lhc.setView(0);
                           showLaunchControls();
                           hideDashboard();

                        } else if (newState == 0) { // Closed (?! Destroyed??)
                           progressMessage("Your accelerator is destroyed");
                           lhc.setView(0);
                           showLaunchControls();
                           hideDashboard();

                           // We have the VM Destroyed. This means
                           // we can change a user
                           $("#boinc-logout").show();
                           boincUpdateStatus(false);

                        }
                     });

                     session.addEventListener('apiAvailable', function() {
                        lhc.setView(2);
                        hideProgress();
                        showDashboard();
                     });

                     session.addEventListener('apiUnavailable', function() {

                        // This is valid only when fired when the VM is running
                        if (lhc.view != 0) {
                           progressMessage("Disconnected from the accelerator");
                           lhc.setView(1);
                           hideDashboard();

                           // Check if the session is also lost
                           session.__session.update();
                           setTimeout(function() {
                              if ((session.state == 2) && (lhc.view != 0)) {

                                 progressMessage("Your accelerator is closed");
                                 lhc.setView(0);
                                 showLaunchControls();
                                 hideDashboard();

                              }
                           }, 1000);
                        }

                     });


                  }, function (err_msg) {

                     // Could not request session
                     lhc.setView(3);
                     progressError( err_msg );

                  });

               },
               function(e) {
                  lhc.setView(3);
                  progressError(e);
               },
               
               // Let the plugin initialize the environment
               true
            );

         }

         // Delaied-initialization
         progressUpdate(0, "Starting WebGL");
         setTimeout(function() {

            // Setup WebGL
            setupWebGL();

            // Schedule CVM initialization
            progressUpdate(0, "Starting CernVM WebAPI");
            setTimeout(function() {

               // Skip initialization if webgl failed
               if (isTimeTraveller) return;

               // Setup CernVM
               setupCVM();

            }, 500);

         }, 500);

         
      });
      
      </script>
      <style type="text/css">
      body {
         overflow: hidden;
         background: #000;
         color: #999;
      }
      #collider {
         position: absolute;
         left: 0px; top: 50%;
         width: 100%; height: 250px;
         margin-top: -125px;
      }
      #loading {
         position: absolute;
         display: block;
         left: 0px; width: 100%;
         top: 50%; height: 50px;
         padding-top: 50px;
      }
      div#loading-message {
         position: relative;
         width: 250px;
         margin: auto;
         margin-top: 5px;
         font-family: 'Armata', sans-serif;
         font-size: 10px;
      }
      div#loading-message > span#loading-percent {
         position: absolute;
         right: 0px;
         top: 0px;
         opacity: 0.5;
      }

      div#loading-message div#loading-text-1, 
      div#loading-message div#loading-text-2 {
         position: absolute;
         display: block;
         text-align: left;
         width: 250px;
         left: 0px;
      }

      div#progressbar {
         margin: auto;
         width: 250px;
         border-top: solid 1px #fff;
      }
      div#progressbar > div#progressbar-value {
         height: 3px;
         display: block;
         background: #fff;
      }

      div#loading.error div, div#loading.error span { color: #f00; }
      div#loading.error div#progressbar { border-top: solid 1px #f00; }
      div#loading.error div#progressbar-value { background: #f00; }

      div#upper-controls {
         height: 35%;
         position: absolute;
         left: 0px;
         top: 0px;
         width: 100%;
      }

      div#lower-controls {
         height: 35%;
         position: absolute;
         left: 0px;
         bottom: 0px;
         width: 100%;
      }

      div#launch-controls {
         position: absolute;
         left: 0px;
         width: 100%;
         top: 70%;
         text-align: center;
      }

      div#boinc-login-form {
         display: block;
         position: absolute;
         left: 0px;
         width: 100%;
         top: 50%;
         height: 300px;
         margin-top: -150px;
      }

      div#boinc-login-form > div {
         display: block;
         margin: auto;
         width: 450px; 
         background: #333;
      }

      div#boinc-login-form > div > form {
         margin: 0px;
      }

      div#not-supported-msg {
         position: absolute;
         left: 0px; width: 100%;
         height: 300px; margin-top: -150px; top: 50%;
      }

      div#not-supported-msg > div {
         display: block;
         margin: auto;
         width: 500px;
         padding-left: 150px;
         background: #333 url(theme/img/time-traveller.png) no-repeat 10px center;
      }

      body.not-ready #upper-controls,
      body.not-ready #lower-controls,
      body.not-ready #launch-controls,
      body.not-ready #boinc-login-form,
      body.not-ready #loading
       {
         display: none;
      }


      </style>
   </head>
   <body class="not-ready">

      <!-- WebGL Graphics -->
      <div id="collider"></div>

      <!-- Loading screen -->
      <div id="loading">
         <div id="progressbar">
            <div id="progressbar-value"></div>
         </div>
         <div id="loading-message">
            <div id="loading-text-1"></div>
            <div id="loading-text-2"></div>
            <span id="loading-percent">10%</span>
         </div>
      </div>

      <!-- Launch controls -->
      <div id="launch-controls">
         <p><a href="javascript:;" onclick="acceleratorStart()" class="btn btn-large btn-warning">Start your accelerator</a></p>
         <p id="boinc-login"><a href="javascript:;" onclick="boincLogin()" class="btn btn-mini btn-inverse">Connect your LHC@Home 2.0 BOINC Account</a></p>
         <p id="boinc-status"><small>Connected with BOINC user <span id="boinc-name" class="text-info">user</span></small> <a href="javascript:;" id="boinc-logout" onclick="boincLogout()" class="btn btn-mini btn-inverse">Disconnect</a></p>
      </div>

      <!-- Webapp Client UI -->
      <div id="upper-controls">
      </div>
      <div id="lower-controls">
         <div style="text-align:right; padding-top: 30px">
            <!-- <a href="javascript:;" onmousedown="acceleratorSetRDPURL(this)" target="_blank" class="btn btn-inverse"><i class="icon-eye-open"></i> Open Display</a>&nbsp; -->
            <a href="javascript:;" onclick="acceleratorOpenRDP()" class="btn btn-inverse"><i class="icon-eye-open"></i> Open Display</a>&nbsp;
            <a href="javascript:;" onclick="acceleratorLogs()" class="btn btn-inverse"><i class="icon-book"></i> Open Logs</a>&nbsp;
            <a href="javascript:;" onclick="aceleratorStop()" class="btn btn-warning"><i class="icon-chevron-down icon-white"></i> Power off</a>&nbsp;
            <a href="javascript:;" onclick="aceleratorCleanup()" class="btn btn-danger"><i class="icon-remove-circle icon-white"></i> Destroy</a>
            &nbsp; &nbsp;
         </div>
      </div>

      <!-- BOINC Login -->
      <div id="boinc-login-form">
         <div class="well">
            <form class="form-horizontal">
               <fieldset>
                  <legend>BOINC Log-in</legend>
                  <p>If you have an <a href="http://lhcathome2.cern.ch/test4theory/" target="_blank">LHC@Home 2.0 Test4Theory</a> account, you can fill-in your account information below in order to collect your BOINC credits:</p>
                  <div class="alert alert-error" id="boinc-error-msg">&nbsp;</div>
                  <div class="control-group">
                     <label class="control-label" for="boinc-login-email">Email</label>
                     <div class="controls">
                        <input type="text" id="boinc-login-email" placeholder="Email">
                     </div>
                  </div>
                  <div class="control-group">
                     <label class="control-label" for="boinc-login-password">Password</label>
                     <div class="controls">
                        <input type="password" id="boinc-login-password" placeholder="Password">
                     </div>
                  </div>
                  <div class="control-group">
                     <div class="controls">
                        <label class="checkbox">
                           <input type="checkbox" checked="checked" id="boinc-login-remember"> Remember me
                        </label>
                     </div>
                  </div>
                  <div class="form-actions">
                     <button onclick="boincDoLogin()" id="boinc-login-submit" type="button" class="btn btn-primary">Login</button>
                     <button onclick="$('#boinc-login-form').fadeOut()" type="button" class="btn">Cancel</button>
                  </div>
               </fieldset>
            </form>
         </div>
      </div>

      <!-- Unsupported browser -->
      <div id="not-supported-msg">
         <div class="well well-large">
            <div>
               <h2>Hello time traveler!</h2>
               <p>It seems that your browser or your hardware from the past does not support WebGL, which is an essential component for this website.</p>
               <p>Why don't you try installing the latest <a href="http://www.mozilla.org/firefox">Mozilla Firefox</a> or <a href="http://www.google.com/chrome">Google Chrome</a>?<br />It might solve this problem.</p>
               <p><em>I'll be here, waiting in the future for you...</em></p>
            </div>
         </div>
      </div>

   </body>
</html>