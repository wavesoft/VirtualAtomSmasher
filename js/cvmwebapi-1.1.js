window.CVM={version:"1.1"};(function(Z){var ab={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(al){for(var ai=0;ai<al.length;ai++){var aj=al[ai].string;var ak=al[ai].prop;this.versionSearchString=al[ai].versionSearch||al[ai].identity;if(aj){if(aj.indexOf(al[ai].subString)!=-1){return al[ai].identity}}else{if(ak){return al[ai].identity}}}},searchVersion:function(aj){var ai=aj.indexOf(this.versionSearchString);if(ai==-1){return}return parseFloat(aj.substring(ai+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};ab.init();var Q=null,F=false,G=[];var k=Z.__globalConfirm=function(ai,aj){if(!aj){if(Q!=null){Q.confirmCallback(window.confirm(ai))}}else{aj(window.confirm(ai))}};Z.setConfirmFunction=function(aj){var ai=false;k=Z.__globalConfirm=function(ak,al){ai=true;aj(ak,function(am){if(ai){ai=false;if(!al){if(Q!=null){Q.confirmCallback(am)}}else{al(am)}}})}};Z.debugLogging=false;Z.autoUpdate=true;var ad=function(ai){alert(ai)};Z.setAlertFunction=function(ai){ad=ai};var I=function(aj,ai){};Z.setGlobalErrorHandler=function(ai){I=ai};var a=function(){},K=function(){},O=function(aj,ai){};Z.setGlobalProgressHandler=Z.setGlobalProgressHandlers=function(ak,aj,ai){if(ak){O=ak}if(aj){a=aj}if(ai){K=ai}};var e=0,g=0,d={},P=0,T=function(ai){if(e==0){if(Z.debugLogging){console.log("[Progress] Started")}a()}if(P!=0){clearTimeout(P);P=0}e+=ai;var aj=++g;d["i"+aj]={t:Number(ai),s:0};return aj},af=function(ai){e-=d["i"+ai].t;delete d["i"+ai];if(e==0){if(P==0){P=setTimeout(function(){P=0;if(Z.debugLogging){console.log("[Progress] Completed")}K()},100)}}},H=function(ao,an,am,ak){var al=0,aj=0;d["i"+ak].s=Number(ao);for(var ai in d){if(ai.substr(0,1)=="i"){al+=d["i"+ak].s;aj+=d["i"+ak].t}}if(Z.debugLogging){console.log("[Progress] "+al+"/"+aj+": "+am)}O(Math.round(100*al/aj),am)};function i(ai,ak,aj){if(ai){if(ai(ak,aj)){return}}console.error("[CernVM Web API] Error #"+aj+": "+ak);I(ak,aj)}var m=[];Z.addInstallProgressHandler=function(ai){m.push(ai)};Z.removeInstallProgressHandler=function(aj){var ai=m.indexOf(aj);m.splice(ai,1)};Z.markPageLoaded=function(){F=true};Z.startCVMWebAPI=function(am,ak,aj){if(ak===true){aj=true;ak=null}var al=function(ap,ao,aq){for(var an=0;an<m.length;an++){m[an](Math.round(100*ap/ao),aq)}};var ai=function(){if(Q==null){Q=document.getElementById("cvmweb-api");if(!Q){Q=document.createElement("embed");if(Q==null){i(ak,"Your browser does not support the <embed /> tag!",-101);return}Q.type="application/x-cvmweb";Q.id="cvmweb-api";Q.style.width="1px";Q.style.height="1px";document.body.appendChild(Q)}console.log("Using CernVM WebAPI "+Q.version+" with "+Q.hypervisorName+" version "+Q.hypervisorVersion)}var an=function(){Q.requestDaemonAccess(function(ap){am(new Z.WebAPIPlugin(Q,ap))},function(ap){i(ak,"Unable to obtain daemon access: "+D(ap),ap)})};if(Q.version==undefined){if(aj){if(ab.browser=="Chrome"){var ao=document.createElement("link");ao.setAttribute("rel","chrome-webstore-item");ao.setAttribute("href","https://chrome.google.com/webstore/detail/iakpghcolokcngbhjiihjcomioihjnfm");document.head.appendChild(ao)}k("This website is using the CernVM Web API extension, but it doesn't seem to be installed in your browser.\n\nDo you want to install it now?",function(aq){if(aq){if(ab.browser=="Firefox"){window.location="http://labs.wavesoft.gr/micro/res/cvmwebapi-1.2.4.xpi"}else{if(ab.browser=="Chrome"){try{chrome.webstore.install("https://chrome.google.com/webstore/detail/iakpghcolokcngbhjiihjcomioihjnfm",function(){location.reload()},function(ar){window.location="https://chrome.google.com/webstore/detail/iakpghcolokcngbhjiihjcomioihjnfm"})}catch(ap){window.location="https://chrome.google.com/webstore/detail/iakpghcolokcngbhjiihjcomioihjnfm"}}else{window.location="http://cernvm.cern.ch/portal/webapi"}}}else{i(ak,"Unable to load CernVM WebAPI Plugin. Make sure it's installed!",-100)}})}else{i(ak,"Unable to load CernVM WebAPI Plugin. Make sure it's installed!",-100)}}else{if(aj){if(Q.hypervisorName==""){k("You are going to need a hypervisor before you can use this website. Do you allow the CernVM Web API extension to install Oracle VirtualBox for you?",function(at){if(at){var aq=true;var ap=function(){if(aq){aq=false}else{return}Q.removeEventListener("install",ap);an()};var ar=function(au){if(aq){aq=false}else{return}Q.removeEventListener("installError",ar);i(ak,"Unable to install hypervisor!",-103)};Q.addEventListener("install",ap);Q.addEventListener("installError",ar);Q.addEventListener("installProgress",al);Q.installHypervisor()}else{i(ak,"User denied hypervisor installation!",-102)}})}else{an()}}else{an()}}};if(!F){G.push(ai)}else{ai()}};var o=0;var U=1;var ag=2;var r=1;var u=0;var c=-1;var q=-2;var ac=-3;var h=-4;var b=-5;var N=-6;var t=-7;var y=-8;var B=-9;var M=-10;var l=-11;var n=-12;var v=-13;var R=-99;var p=-100;var J=0;var f=1;var S=2;var z=3;var A=4;var V=5;var Y=6;var aa=1;var x=2;var ae=4;var s=8;var W=16;var w=1;var X=2;function E(ai){if(ai==J){return"Closed"}if(ai==f){return"Oppening"}if(ai==S){return"Open"}if(ai==z){return"Starting"}if(ai==A){return"Started"}if(ai==V){return"Error"}if(ai==Y){return"Paused"}return"Unknown state "+ai}function D(ai){if(ai==ag){return"Already exists"}if(ai==r){return"Scheduled"}if(ai==u){return"No error"}if(ai==c){return"Creation Error"}if(ai==q){return"Modification Error"}if(ai==ac){return"Control Error"}if(ai==h){return"Deletion Error"}if(ai==b){return"Query Error"}if(ai==N){return"I/O Error"}if(ai==t){return"Server/Library Error"}if(ai==y){return"Invalid state for such action"}if(ai==B){return"The requested resource was not found"}if(ai==M){return"Access denied"}if(ai==l){return"The requested action is not supported"}if(ai==n){return"Unable to validate the resource"}if(ai==v){return"The domain is not trusted"}if(ai==R){return"Usage error"}if(ai==p){return"The requested functionality is not implemented"}return"Unknown error #"+ai}window.addEventListener("load",function(aj){F=true;for(var ai=0;ai<G.length;ai++){G[ai]()}});Z.EventDispatcher=function(ai){this.events={}};Z.EventDispatcher.prototype.__fire=function(aj){var ai=Array.prototype.slice.call(arguments),aj=ai.shift();if(Z.debugLogging){console.log("Firing",aj,"(",ai,")")}if(this.events[aj]==undefined){return}var al=this.events[aj];for(var ak=0;ak<al.length;ak++){al[ak].apply(this,ai)}};Z.EventDispatcher.prototype.addEventListener=function(ai,aj){if(this.events[ai]==undefined){this.events[ai]=[]}this.events[ai].push(aj)};Z.EventDispatcher.prototype.removeEventListener=function(ai,ak){if(this.events[ai]==undefined){return}var aj=this.events[ai].indexOf(ak);if(aj<0){return}this.events.splice(aj,1)};var aa=1;var x=2;var ae=4;var s=8;var ah=function(aj){var ai=0;if(aj.use64bit){ai|=aa}if(aj.useBootDisk){ai|=x}if(aj.useGuestAdditions){ai|=ae}if(aj.useFloppyIO){ai|=s}if(aj.HVF_HEADFUL){ai|=W}return ai};var j=function(ak){var ai=function(al){ak.flags=al},aj=function(){return ak.flags};Object.defineProperties(this,{value:{get:function(){return aj()},set:function(al){ai(al)}},use64bit:{get:function(){return((aj()&aa)!=0)},set:function(al){if(al){ai(aj()|aa)}else{ai(aj()&~aa)}}},useBootDisk:{get:function(){return((aj()&x)!=0)},set:function(al){if(al){ai(aj()|x)}else{ai(aj()&~x)}}},useGuestAdditions:{get:function(){return((aj()&ae)!=0)},set:function(al){if(al){ai(aj()|ae)}else{ai(aj()&~ae)}}},useFloppyIO:{get:function(){return((aj()&s)!=0)},set:function(al){if(al){ai(aj()|s)}else{ai(aj()&~s)}}},headful:{get:function(){return((aj()&W)!=0)},set:function(al){if(al){ai(aj()|W)}else{ai(aj()&~W)}}}})};var L=function(aj){var ai=0;if(aj.suspend){ai|=w}if(aj.autoStart){ai|=X}return ai};var C=function(ak){var ai=function(al){ak.daemonFlags=al},aj=function(){return ak.daemonFlags};Object.defineProperties(this,{value:{get:function(){return aj()},set:function(al){ai(al)}},suspend:{get:function(){return((aj()&w)!=0)},set:function(al){if(al){ai(aj()|w)}else{ai(aj()&~w)}}},autoStart:{get:function(){return((aj()&X)!=0)},set:function(al){if(al){ai(aj()|X)}else{ai(aj()&~X)}}}})};Z.WebAPIPlugin=function(aj,al){Z.EventDispatcher.call(this);this.__plugin=aj;this.__daemon=al;Object.defineProperties(this,{domain:{get:function(){return this.__plugin.domain}}});var ak=false,ai=0;this.__plugin.addEventListener("installProgress",(function(an,am,ao){if(!ak){this.__fire("installProgressBegin");ai=T(am);ak=true}this.__fire("installProgress",Math.round(100*an/am),ao);H(an,am,ao,ai);if(an==am){this.__fire("installProgressEnd");ak=false}}).bind(this));this.__plugin.addEventListener("install",(function(){this.__fire("installCompleted");af(ai)}).bind(this));this.__plugin.addEventListener("installError",(function(){this.__fire("installError");af(ai)}).bind(this))};Z.WebAPIPlugin.prototype=Object.create(Z.EventDispatcher.prototype);Z.WebAPIPlugin.prototype.hasHypervisor=function(){if(!this.__plugin){return false}return(this.__plugin.version!=undefined)&&(this.__plugin.hypervisorName!="")},Z.WebAPIPlugin.prototype.requestSession=function(ak,an,al){if(!ak){return false}if(!an){return false}if(typeof(ak)!="string"){return false}if(typeof(an)!="function"){return false}if((al)&&(typeof(al)!="function")){return false}var aj=false,ai=0,am=(function(ap,ao,aq){if(!aj){this.__fire("progressBegin");ai=T(ao);aj=true}this.__fire("progress",Math.round(100*ap/ao),aq);H(ap,ao,aq,ai);console.log("[DBG] ",ap,"==",ao);if(ap==ao){this.__fire("progressEnd");af(ai);aj=false}}).bind(this);this.__plugin.requestSafeSession(ak,(function(ar){cSession=ar;if(Z.debugLogging){cSession.addEventListener("debug",function(at){console.log("[Debug] "+at)})}cSession.addEventListener("progress",am);if((ar.state==J)||(ar.state==V)){var aq=true;var ap=(function(){if(aq){aq=false}else{return}ar.removeEventListener("open",ap);an(new Z.WebAPISession(this.__plugin,this.__daemon,ar))}).bind(this);var ao=(function(au,at){if(aq){aq=false}else{return}ar.removeEventListener("error",ao);i(al,"Could not open session: "+D(at)+".",at)}).bind(this);ar.addEventListener("open",ap);ar.addEventListener("openError",ao);ar.open()}else{an(new Z.WebAPISession(this.__plugin,this.__daemon,ar))}}).bind(this),function(ao){console.error("RequestSession Error #"+ao);i(al,"Could not request session: "+D(ao)+".",ao)},am)};Z.WebAPISession=function(ak,am,ao){Z.EventDispatcher.call(this);this.__plugin=ak;this.__daemon=am;this.__session=ao;this.__valid=true;this.__daemonStatus=false;this.__systemStatus=false;this.autoUpdate=Z.autoUpdate;this.__checkDaemonUpdates=function(){var ap=this.__daemon.isRunning;if(ap!=this.__daemonStatus){this.__daemonStatus=ap;this.__fire("daemonStateChange",ap)}if(ap){var aq=this.__daemon.isSystemIdle;if(aq!=this.__systemStatus){this.__systemStatus=aq;this.__fire("systemStateChange",aq)}}};var ai=setInterval((function(){if(this.autoUpdate){this.__session.update()}this.__checkDaemonUpdates()}).bind(this),5000);var aj=undefined;Object.defineProperties(this,{state:{get:function(){if(!this.__valid){return aj}return this.__session.state}},stateName:{get:function(){if(!this.__valid){return aj}return E(this.__session.state)}},ip:{get:function(){if(!this.__valid){return aj}return this.__session.ip}},ram:{get:function(){if(!this.__valid){return aj}return this.__session.ram}},disk:{get:function(){if(!this.__valid){return aj}return this.__session.disk}},apiURL:{get:function(){if(!this.__valid){return aj}return this.__session.apiURL}},rdpURL:{get:function(){if(!this.__valid){return aj}return this.__session.rdpURL}},executionCap:{get:function(){if(!this.__valid){return aj}return this.__session.executionCap},set:function(ap){this.__session.setExecutionCap(ap)}},daemonMinCap:{get:function(){if(!this.__valid){return aj}return this.__session.daemonMinCap},set:function(ap){this.__session.daemonMinCap=ap}},daemonMaxCap:{get:function(){if(!this.__valid){return aj}return this.__session.daemonMaxCap},set:function(ap){this.__session.daemonMaxCap=ap}},daemonControlled:{get:function(){if(!this.__valid){return aj}return this.__session.daemonControlled},set:function(ap){this.__session.daemonControlled=ap;setTimeout((function(){this.__checkDaemonUpdates()}).bind(this),500)}},version:{get:function(){if(!this.__valid){return aj}return((this.__session.flags&x)==0)?this.__session.version:""}},diskURL:{get:function(){if(!this.__valid){return aj}return((this.__session.flags&x)!=0)?this.__session.version:""}},flags:{get:function(){if(!this.__valid){return aj}return new j(this.__session)},set:function(ap){if(typeof(ap)=="number"){this.__session.flags=ap}else{if(typeof(ap)=="object"){this.__session.flags=ah(ap)}}}},daemonFlags:{get:function(){if(!this.__valid){return aj}return new C(this.__session)},set:function(ap){if(typeof(ap)=="number"){this.__session.daemonFlags=ap}else{if(typeof(ap)=="object"){this.__session.daemonFlags=L(ap)}}}}});var an=(function(){clearInterval(ai);this.__valid=false}).bind(this);this.__session.addEventListener("open",(function(){this.__fire("sessionStateChange",S);this.__fire("open")}).bind(this));this.__session.addEventListener("close",(function(){this.__fire("sessionStateChange",J);this.__fire("close");an()}).bind(this));this.__session.addEventListener("start",(function(){this.__fire("sessionStateChange",A);this.__fire("start")}).bind(this));this.__session.addEventListener("stop",(function(){this.__fire("sessionStateChange",S);this.__fire("stop")}).bind(this));this.__session.addEventListener("pause",(function(){this.__fire("sessionStateChange",Y);this.__fire("pause")}).bind(this));this.__session.addEventListener("resume",(function(){this.__fire("sessionStateChange",A);this.__fire("resume")}).bind(this));this.__session.addEventListener("hibernate",(function(){this.__fire("sessionStateChange",S);this.__fire("hibernate")}).bind(this));this.__session.addEventListener("error",(function(aq,ap,ar){this.__fire("error",aq,ap,ar)}).bind(this));this.__session.addEventListener("reset",(function(aq,ap,ar){this.__fire("reset")}).bind(this));this.__session.addEventListener("openError",(function(aq,ap){this.__fire("openError",aq,ap)}).bind(this));this.__session.addEventListener("closeError",(function(aq,ap){this.__fire("closeError",aq,ap)}).bind(this));this.__session.addEventListener("startError",(function(aq,ap){this.__fire("startError",aq,ap)}).bind(this));this.__session.addEventListener("stopError",(function(aq,ap){this.__fire("stopError",aq,ap)}).bind(this));this.__session.addEventListener("pauseError",(function(aq,ap){this.__fire("pauseError",aq,ap)}).bind(this));this.__session.addEventListener("resetError",(function(aq,ap){this.__fire("resetError",aq,ap)}).bind(this));this.__session.addEventListener("hibernateError",(function(aq,ap){this.__fire("hibernateError",aq,ap)}).bind(this));this.__session.addEventListener("apiAvailable",(function(aq,ap){this.__fire("apiAvailable",aq,ap)}).bind(this));this.__session.addEventListener("apiUnavailable",(function(){this.__fire("apiUnavailable")}).bind(this));var al=false;this.__session.addEventListener("progress",(function(aq,ap,ar){if(!al){this.__fire("progressBegin");al=true}this.__fire("progress",Math.round(100*aq/ap),ar);if(aq==ap){this.__fire("progressEnd");al=false}}).bind(this));setTimeout((function(){this.__fire("daemonStateChange",this.__daemonStatus);this.__fire("systemStateChange",this.__systemStatus);if(this.__session.state!=J){this.__fire("sessionStateChange",this.__session.state)}}).bind(this),1)};Z.WebAPISession.prototype=Object.create(Z.EventDispatcher.prototype);Z.WebAPISession.prototype.start=function(al,ap,ao){if(!this.__valid){return false}if(typeof(al)=="function"){ao=ap;ap=al;al=false}if(!al){al={}}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ap){ap()}ai()},an=function(ar,aq){if(aj){aj=false}else{return}i(ao,"Could not start: "+ar,aq);ai()},ai=(function(){this.__session.removeEventListener("start",ak);this.__session.removeEventListener("startError",an)}).bind(this);this.__session.addEventListener("start",ak);this.__session.addEventListener("startError",an);var am=this.__session.start(al);if(am!=r){i(ao,"Could not start: "+D(am),am);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.stop=function(ao,an){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ao){ao()}ai()},am=function(aq,ap){if(aj){aj=false}else{return}i(an,"Could not stop: "+aq,ap);ai()},ai=(function(){this.__session.removeEventListener("stop",ak);this.__session.removeEventListener("stopError",am)}).bind(this);this.__session.addEventListener("stop",ak);this.__session.addEventListener("stopError",am);var al=this.__session.stop();if(al!=r){i(an,"Could not stop: "+D(al),al);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.pause=function(ao,an){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ao){ao()}ai()},am=function(aq,ap){if(aj){aj=false}else{return}i(an,"Could not pause: "+aq,ap);ai()},ai=(function(){this.__session.removeEventListener("pause",ak);this.__session.removeEventListener("pauseError",am)}).bind(this);this.__session.addEventListener("pause",ak);this.__session.addEventListener("pauseError",am);var al=this.__session.pause();if(al!=r){i(an,"Could not pause: "+D(al),al);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.resume=function(ao,an){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ao){ao()}ai()},am=function(aq,ap){if(aj){aj=false}else{return}i(an,"Could not resume: "+aq,ap);ai()},ai=(function(){this.__session.removeEventListener("resume",ak);this.__session.removeEventListener("resumeError",am)}).bind(this);this.__session.addEventListener("resume",ak);this.__session.addEventListener("resumeError",am);var al=this.__session.resume();if(al!=r){i(an,"Could not resume: "+D(al),al);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.hibernate=function(ao,an){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ao){ao()}ai()},am=function(aq,ap){if(aj){aj=false}else{return}i(an,"Could not hibernate: "+aq,ap);ai()},ai=(function(){this.__session.removeEventListener("hibernate",ak);this.__session.removeEventListener("hibernateError",am)}).bind(this);this.__session.addEventListener("hibernate",ak);this.__session.addEventListener("hibernateError",am);var al=this.__session.hibernate();if(al!=r){i(an,"Could not hibernate: "+D(al),al);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.reset=function(ao,an){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(ao){ao()}ai()},am=function(aq,ap){if(aj){aj=false}else{return}i(an,"Could not reset: "+aq,ap);ai()},ai=(function(){this.__session.removeEventListener("reset",ak);this.__session.removeEventListener("resetError",am)}).bind(this);this.__session.addEventListener("reset",ak);this.__session.addEventListener("resetError",am);var al=this.__session.reset();if(al!=r){i(an,"Could not reset: "+D(al),al);return false}this.__checkDaemonUpdates();return true};Z.WebAPISession.prototype.close=function(al){if(!this.__valid){return false}var aj=true,ak=function(){if(aj){aj=false}else{return}if(al){al()}ai()},ai=(function(){this.__session.removeEventListener("close",ak)}).bind(this);this.__session.addEventListener("close",ak);this.__session.close();this.__valid=false;this.__checkDaemonUpdates();return true};window.addEventListener("load",function(aj){F=true;for(var ai=0;ai<G.length;ai++){G[ai]()}})})(window.CVM);